<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job System Test UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #0d1117; color: #c9d1d9; padding: 20px; }
        .card { background: #161b22; border: 1px solid #30363d; }
        .progress { background: #21262d; }
        .btn-primary { background: #238636; border-color: #238636; }
        .btn-primary:hover { background: #2ea043; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">üß™ Job System Test Interface</h1>

        <!-- Job Creation -->
        <div class="card mb-3">
            <div class="card-header">
                <h5>1. Create Preview Job</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label>Selection Mode</label>
                        <select id="mode" class="form-control bg-dark text-light">
                            <option value="latest">Latest Articles</option>
                            <option value="unanalyzed">Unanalyzed Only</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>Count</label>
                        <input type="number" id="count" class="form-control bg-dark text-light" value="5">
                    </div>
                    <div class="col-md-4">
                        <label>Model</label>
                        <select id="model" class="form-control bg-dark text-light">
                            <option value="gpt-4.1-nano">GPT-4.1-nano</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary mt-3" onclick="createJob()">Create Preview Job</button>
            </div>
        </div>

        <!-- Job Status -->
        <div class="card mb-3" id="job-status" style="display:none;">
            <div class="card-header">
                <h5>2. Job Status</h5>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Job ID:</strong> <span id="job-id">-</span>
                </div>
                <div class="mb-2">
                    <strong>Status:</strong> <span id="job-state" class="badge bg-secondary">-</span>
                </div>
                <div class="mb-2">
                    <strong>Items:</strong> <span id="job-items">-</span>
                </div>
                <div class="mb-2">
                    <strong>Cost:</strong> $<span id="job-cost">-</span>
                </div>
                <div class="mb-3">
                    <strong>Duration:</strong> <span id="job-duration">-</span> minutes
                </div>
                <button class="btn btn-success" onclick="confirmJob()">‚úÖ Confirm & Start</button>
                <button class="btn btn-danger" onclick="cancelJob()">‚ùå Cancel</button>
            </div>
        </div>

        <!-- Run Progress -->
        <div class="card" id="run-progress" style="display:none;">
            <div class="card-header">
                <h5>3. Analysis Progress</h5>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Run ID:</strong> <span id="run-id">-</span>
                </div>
                <div class="mb-2">
                    <strong>Status:</strong> <span id="run-status" class="badge bg-info">-</span>
                </div>
                <div class="progress mb-3" style="height: 25px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%">
                        <span id="progress-text">0%</span>
                    </div>
                </div>
                <div>
                    <strong>Processed:</strong> <span id="processed">0</span> / <span id="total">0</span> items
                </div>
            </div>
        </div>

        <!-- Log Output -->
        <div class="card mt-3">
            <div class="card-header">
                <h5>üìã Log Output</h5>
            </div>
            <div class="card-body">
                <pre id="log" style="max-height: 300px; overflow-y: auto; background: #0d1117; padding: 10px;"></pre>
            </div>
        </div>
    </div>

    <script>
        let currentJobId = null;
        let currentRunId = null;
        let pollInterval = null;

        function log(message) {
            const logEl = document.getElementById('log');
            logEl.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function createJob() {
            const mode = document.getElementById('mode').value;
            const count = parseInt(document.getElementById('count').value);
            const model = document.getElementById('model').value;

            log(`Creating preview job: ${mode}, ${count} items, ${model}...`);

            try {
                const response = await fetch('/api/analysis/jobs/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        selection: { mode, count },
                        parameters: {
                            model_tag: model,
                            rate_per_second: 1.0,
                            limit: count
                        },
                        filters: { unanalyzed_only: true }
                    })
                });

                const data = await response.json();

                if (data.job_id) {
                    currentJobId = data.job_id;
                    log(`‚úÖ Job created: ${currentJobId}`);

                    // Update UI
                    document.getElementById('job-status').style.display = 'block';
                    document.getElementById('job-id').textContent = currentJobId;
                    document.getElementById('job-state').textContent = 'PREVIEW';
                    document.getElementById('job-items').textContent = data.estimates.item_count;
                    document.getElementById('job-cost').textContent = data.estimates.estimated_cost_usd.toFixed(4);
                    document.getElementById('job-duration').textContent = data.estimates.estimated_duration_minutes;
                } else {
                    log(`‚ùå Failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
            }
        }

        async function confirmJob() {
            if (!currentJobId) return;

            log(`Confirming job ${currentJobId}...`);

            try {
                // Confirm job
                const confirmResponse = await fetch(`/api/analysis/jobs/${currentJobId}/confirm`, {
                    method: 'POST'
                });

                if (confirmResponse.ok) {
                    log(`‚úÖ Job confirmed`);
                    document.getElementById('job-state').textContent = 'CONFIRMED';
                    document.getElementById('job-state').className = 'badge bg-success';

                    // Start analysis
                    log(`Starting analysis...`);
                    const startResponse = await fetch('/api/analysis/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ job_id: currentJobId })
                    });

                    const runData = await startResponse.json();

                    if (runData.id) {
                        currentRunId = runData.id;
                        log(`‚úÖ Analysis started: Run ${currentRunId}`);

                        // Show progress UI
                        document.getElementById('run-progress').style.display = 'block';
                        document.getElementById('run-id').textContent = currentRunId;

                        // Start polling
                        startPolling();
                    }
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
            }
        }

        async function cancelJob() {
            if (!currentJobId) return;

            log(`Cancelling job ${currentJobId}...`);

            try {
                const response = await fetch(`/api/analysis/jobs/${currentJobId}/cancel`, {
                    method: 'POST'
                });

                if (response.ok) {
                    log(`‚úÖ Job cancelled`);
                    document.getElementById('job-state').textContent = 'CANCELLED';
                    document.getElementById('job-state').className = 'badge bg-danger';
                    stopPolling();
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
            }
        }

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);

            pollInterval = setInterval(async () => {
                if (!currentRunId) return;

                try {
                    const response = await fetch(`/api/analysis/status/${currentRunId}`);
                    const status = await response.json();

                    // Update UI
                    const processed = status.processed_items || 0;
                    const total = status.total_items || 0;
                    const percent = total > 0 ? (processed / total * 100) : 0;

                    document.getElementById('run-status').textContent = status.status?.toUpperCase() || 'UNKNOWN';
                    document.getElementById('processed').textContent = processed;
                    document.getElementById('total').textContent = total;
                    document.getElementById('progress-bar').style.width = percent + '%';
                    document.getElementById('progress-text').textContent = Math.round(percent) + '%';

                    // Update badge color
                    const badge = document.getElementById('run-status');
                    badge.className = 'badge ' + (
                        status.status === 'completed' ? 'bg-success' :
                        status.status === 'running' ? 'bg-info' :
                        status.status === 'failed' ? 'bg-danger' :
                        'bg-secondary'
                    );

                    if (status.status === 'completed' || status.status === 'failed') {
                        log(`üéâ Analysis ${status.status}!`);
                        stopPolling();
                    }
                } catch (error) {
                    log(`‚ö†Ô∏è Polling error: ${error.message}`);
                }
            }, 2000);

            log('üìä Started status polling...');
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
                log('‚èπÔ∏è Stopped polling');
            }
        }

        // Initialize
        log('üöÄ Job System Test UI Ready');
    </script>
</body>
</html>