{% extends "base.html" %}

{% block title %}Analysis Cockpit v4.0 - News MCP{% endblock %}

{% block extra_head %}
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js"></script>
<style>
        :root[data-theme="dark"] {
            --bg-primary: #1a1d20;
            --bg-secondary: #2b2d30;
            --bg-card: rgba(255,255,255,0.05);

            --text-primary: #e9ecef;
            --text-secondary: #dee2e6;
            --text-muted: #adb5bd;

            --border-default: rgba(255,255,255,0.1);
            --border-light: rgba(255,255,255,0.05);

            --accent-primary: #0d6efd;
            --accent-success: #198754;
            --accent-warning: #ffc107;
            --accent-danger: #dc3545;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-default);
        }

        .control-panel {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .progress {
            height: 24px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }

        .progress-bar {
            font-size: 14px;
            font-weight: 500;
            transition: width 0.3s ease;
        }

        .metric-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            border: 1px solid var(--border-default);
            padding: 1.25rem;
            border-radius: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-control, .form-select {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-control:focus, .form-select:focus {
            background-color: var(--bg-secondary);
            border-color: var(--accent-primary);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        .form-label {
            color: var(--text-primary) !important;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .badge-sentiment { background-color: var(--accent-primary); }
        .badge-urgency { background-color: var(--accent-warning); }
        .badge-impact { background-color: #6f42c1; }

        .article-preview {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s;
        }

        .article-preview:hover {
            background-color: rgba(255,255,255,0.08);
        }

        .btn-tab {
            transition: all 0.2s;
        }

        .btn-tab:not(.active) {
            opacity: 0.7;
        }

        #article-preview > .card-body {
            display: block !important;
        }

        /* Article Preview Styles */
        .article-item {
            display: flex;
            gap: 12px;
            padding: 14px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        .article-item:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
        }
        .article-number {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(13, 110, 253, 0.15);
            border: 1px solid rgba(13, 110, 253, 0.3);
            border-radius: 4px;
            color: #60a5fa;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .article-content {
            flex: 1;
            min-width: 0;
        }
        .article-title-row {
            margin-bottom: 8px;
        }
        .article-title {
            color: #e9ecef;
            font-size: 1rem;
            line-height: 1.4;
            margin: 0;
            font-weight: 500;
        }
        .article-meta-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        .article-feed {
            color: #60a5fa;
            font-weight: 500;
        }
        .article-date {
            color: #9ca3af;
        }
        .article-description {
            color: #adb5bd;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        .article-footer-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        .article-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .btn-link {
            color: #60a5fa;
            text-decoration: none;
            font-size: 0.85rem;
            transition: color 0.2s;
        }
        .btn-link:hover {
            color: #93c5fd;
            text-decoration: underline;
        }
        .article-id {
            color: #6b7280;
            font-size: 0.8rem;
        }
        .articles-footer {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .pagination-info {
            text-align: center;
            color: #9ca3af;
            font-size: 0.85rem;
        }
        .pagination-info .separator {
            margin: 0 8px;
            color: #6b7280;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(13, 110, 253, 0.1) 0%, rgba(13, 110, 253, 0.05) 100%);
            border: 1px solid rgba(13, 110, 253, 0.2);
            border-radius: 12px;
            padding: 1.5rem 1rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #0d6efd 0%, #0dcaf0 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(13, 110, 253, 0.25);
            border-color: rgba(13, 110, 253, 0.4);
        }
        .stat-card:hover::before {
            opacity: 1;
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #e9ecef;
            line-height: 1;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-label {
            font-size: 0.875rem;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
        }

        [x-cloak] { display: none !important; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-4" x-data="analysisControlV4()">

    <!-- Header -->
        <div class="row mb-2">
            <div class="col">
                <h1 class="h5 mb-1" style="color: var(--text-primary);">Analysis Cockpit v4.0</h1>
            </div>
        </div>

        <!-- Statistics Dashboard -->
        <div class="row mb-4" id="stats-dashboard" hx-get="/htmx/analysis/stats-horizontal" hx-trigger="load, every 30s" hx-swap="innerHTML">
            <div class="col">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="row">
            <!-- Left Panel: Control -->
            <div class="col-lg-4">
                <div class="control-panel mb-4">

                    <!-- Target Selection -->
                    <div class="mb-4">
                        <h5 class="mb-3" style="color: var(--text-primary);">🎯 Target Selection</h5>

                        <!-- Mode Tabs -->
                        <div class="btn-group w-100 mb-3" role="group">
                            <button type="button"
                                    class="btn btn-tab"
                                    style="font-size: 0.95rem; font-weight: 500;"
                                    :class="futureRun.selection.mode === 'latest' ? 'btn-primary active' : 'btn-outline-light'"
                                    @click="setMode('latest')">
                                📰 Latest
                            </button>
                            <button type="button"
                                    class="btn btn-tab"
                                    style="font-size: 0.95rem; font-weight: 500;"
                                    :class="futureRun.selection.mode === 'timeRange' ? 'btn-primary active' : 'btn-outline-light'"
                                    @click="setMode('timeRange')">
                                🕐 Time Range
                            </button>
                            <button type="button"
                                    class="btn btn-tab"
                                    style="font-size: 0.95rem; font-weight: 500;"
                                    :class="futureRun.selection.mode === 'unanalyzed' ? 'btn-primary active' : 'btn-outline-light'"
                                    @click="setMode('unanalyzed')">
                                🔍 Unanalyzed
                            </button>
                        </div>

                        <!-- Latest Mode -->
                        <div x-show="futureRun.selection.mode === 'latest'" x-cloak class="mb-3">
                            <label class="form-label">Number of articles (1-1000)</label>
                            <input type="number"
                                   class="form-control"
                                   x-model.number="futureRun.selection.count"
                                   @blur="articlePage = 1; createSelection()"
                                   @keyup.enter="articlePage = 1; createSelection()"
                                   min="1"
                                   max="1000">
                            <small style="color: var(--text-muted);">Will select the N most recent articles</small>
                        </div>

                        <!-- Time Range Mode -->
                        <div x-show="futureRun.selection.mode === 'timeRange'" x-cloak class="mb-3">
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">Days</label>
                                    <input type="number"
                                           class="form-control"
                                           x-model.number="futureRun.selection.days"
                                           @blur="articlePage = 1; createSelection()"
                                           @keyup.enter="articlePage = 1; createSelection()"
                                           min="0"
                                           max="365">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Hours</label>
                                    <input type="number"
                                           class="form-control"
                                           x-model.number="futureRun.selection.hours"
                                           @blur="articlePage = 1; createSelection()"
                                           @keyup.enter="articlePage = 1; createSelection()"
                                           min="0"
                                           max="23">
                                </div>
                            </div>
                            <small style="color: var(--text-muted);">Articles from the specified time period</small>
                        </div>

                        <!-- Unanalyzed Mode -->
                        <div x-show="futureRun.selection.mode === 'unanalyzed'" x-cloak class="mb-3">
                            <div class="alert alert-warning small mb-0">
                                Will select ALL unanalyzed articles. Use with caution for large datasets!
                            </div>
                        </div>
                    </div>

                    <!-- Feed Filter -->
                    <div class="mb-4">
                        <h6 class="mb-3" style="color: var(--text-primary);">📡 Feed Filter <small style="color: var(--text-muted);">(Optional)</small></h6>

                        <div class="form-check mb-2">
                            <input class="form-check-input"
                                   type="checkbox"
                                   x-model="feedFilterEnabled"
                                   @change="articlePage = 1; if (!feedFilterEnabled) { futureRun.selection.feed_id = null; } createSelection();"
                                   id="enableFeedFilter">
                            <label class="form-check-label" for="enableFeedFilter">
                                Limit to specific feed
                            </label>
                        </div>

                        <select class="form-select"
                                x-model="futureRun.selection.feed_id"
                                @change="articlePage = 1; createSelection()"
                                :disabled="!feedFilterEnabled"
                                x-show="feedFilterEnabled"
                                x-cloak>
                            <option value="">Select feed...</option>
                            <template x-for="feed in availableFeeds" :key="feed.id">
                                <option :value="feed.id" x-text="feed.title"></option>
                            </template>
                        </select>
                    </div>

                    <!-- Model & Parameters -->
                    <div class="mb-4">
                        <h6 class="mb-3" style="color: var(--text-primary);">🤖 Model & Parameters</h6>

                        <div class="mb-3">
                            <label class="form-label">Model</label>
                            <select class="form-select" x-model="futureRun.model.tag" @change="updatePreview()">
                                <option value="gpt-4.1-nano">GPT-4.1 Nano (US $0.40/1M tokens)</option>
                                <option value="gpt-4-mini">GPT-4 Mini (US $0.80/1M tokens)</option>
                            </select>
                        </div>

                        <div class="row">
                            <div class="col-6">
                                <label class="form-label">Rate/sec</label>
                                <input type="number"
                                       class="form-control"
                                       x-model.number="futureRun.model.rate_per_second"
                                       min="0.1"
                                       max="10"
                                       step="0.1">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Limit</label>
                                <input type="number"
                                       class="form-control"
                                       x-model.number="futureRun.model.limit"
                                       @blur="updatePreviewFromLimit()"
                                       @keyup.enter="updatePreviewFromLimit()"
                                       min="1"
                                       max="10000">
                            </div>
                        </div>
                    </div>

                    <!-- Additional Settings -->
                    <div class="mb-4">
                        <h6 class="mb-3" style="color: var(--text-primary);">⚙️ Additional Settings</h6>

                        <div class="form-check">
                            <input class="form-check-input"
                                   type="checkbox"
                                   x-model="futureRun.settings.override_existing"
                                   @change="articlePage = 1; createSelection()"
                                   id="overrideExisting">
                            <label class="form-check-label" for="overrideExisting">
                                Re-analyze already processed articles
                            </label>
                        </div>
                        <small style="color: var(--text-muted);">Check to run analysis even for items that were already analyzed</small>
                    </div>

                    <!-- Preview & Start -->
                    <div class="mb-4">
                        <h6 class="mb-3" style="color: var(--text-primary);">🚀 Preview & Start</h6>

                        <!-- Preview Metrics -->
                        <div class="row g-2 mb-3">
                            <div class="col-4">
                                <div class="card text-center p-2">
                                    <div class="h4 mb-0" style="color: var(--text-primary);" x-text="preview.total_items"></div>
                                    <small style="color: var(--text-muted);">TOTAL</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="card text-center p-2">
                                    <div class="h4 mb-0 text-success" style="color: #198754 !important;" x-text="preview.already_analyzed_count"></div>
                                    <small style="color: var(--text-muted);">ANALYZED</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="card text-center p-2">
                                    <div class="h4 mb-0 text-warning" style="color: #ffc107 !important;" x-text="preview.new_items_count"></div>
                                    <small style="color: var(--text-muted);">TO ANALYZE</small>
                                </div>
                            </div>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <div class="card text-center p-2">
                                    <div class="small" style="color: var(--text-primary);">💰 <span x-text="'$' + preview.estimated_cost_usd.toFixed(4)"></span></div>
                                    <small style="color: var(--text-muted);">EST. COST</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card text-center p-2">
                                    <div class="small" style="color: var(--text-primary);">⏱️ <span x-text="preview.estimated_duration_minutes + ' min'"></span></div>
                                    <small style="color: var(--text-muted);">EST. TIME</small>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-lg"
                                    @click="startRun()"
                                    :disabled="loading || currentJobStatus.status === 'running'">
                                <span x-show="!loading">🚀 Start Analysis</span>
                                <span x-show="loading" class="spinner-border spinner-border-sm"></span>
                            </button>

                            <button class="btn btn-outline-secondary"
                                    @click="updatePreview()"
                                    :disabled="loading">
                                🔄 Refresh Preview
                            </button>
                        </div>

                        <!-- Job Status -->
                        <div x-show="currentJobStatus.status !== 'idle'"
                             class="alert mt-3 mb-0"
                             :class="{
                                 'alert-info': currentJobStatus.status === 'running',
                                 'alert-success': currentJobStatus.status === 'done',
                                 'alert-warning': currentJobStatus.status === 'cancelled',
                                 'alert-danger': currentJobStatus.status === 'error'
                             }"
                             x-cloak>
                            <div class="d-flex justify-content-between align-items-center">
                                <small>
                                    <strong x-text="currentJobStatus.message"></strong>
                                    <span x-show="currentJobStatus.id"> (Job ID: <span x-text="currentJobStatus.id"></span>)</span>
                                </small>
                                <button x-show="currentJobStatus.status === 'running'"
                                        @click="cancelRun()"
                                        class="btn btn-sm btn-outline-danger">
                                    ✕ Cancel
                                </button>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Active Runs -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0" style="color: var(--text-primary);">⚡ Active Runs</h6>
                    </div>
                    <div class="card-body">
                        <div id="active-runs"
                             hx-get="/htmx/analysis/runs/active"
                             hx-trigger="load, every 3s"
                             hx-swap="innerHTML">
                            <div class="d-flex justify-content-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0" style="color: var(--text-primary);">📊 History</h6>
                    </div>
                    <div class="card-body">
                        <div id="run-history"
                             hx-get="/htmx/analysis/runs/history?limit=10"
                             hx-trigger="load, every 30s"
                             hx-swap="innerHTML">
                            <div class="d-flex justify-content-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right Panel: Preview & Monitoring -->
            <div class="col-lg-8">

                <!-- Live Article Preview -->
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <h6 class="mb-0" style="color: var(--text-primary);">📄 Article Preview</h6>
                                <small style="color: var(--text-muted);">10 articles per page</small>
                            </div>
                            <button class="btn btn-sm btn-outline-primary"
                                    @click="articlesState.page = 1">
                                🔄 Refresh
                            </button>
                        </div>
                        <div class="btn-group btn-group-sm w-100" role="group">
                            <button class="btn btn-outline-light"
                                    @click="articlesState.page = Math.max(1, articlesState.page - 1)"
                                    :disabled="articlesState.page <= 1"
                                    style="flex: 0 0 auto;">◀ Prev</button>
                            <button class="btn btn-outline-secondary" disabled style="flex: 1;">
                                <span x-text="'Page ' + articlesState.page + ' of ' + totalFilteredPages"></span>
                                <small x-show="filteredArticles.length > 0" class="ms-1" x-text="'(' + filteredArticles.length + ' total)'"></small>
                            </button>
                            <button class="btn btn-outline-light"
                                    @click="articlesState.page++"
                                    :disabled="articlesState.page >= totalFilteredPages"
                                    style="flex: 0 0 auto;">Next ▶</button>
                        </div>
                    </div>
                    <div class="card-body p-3">
                        <div id="article-preview">
                            <div x-show="paginatedArticles.length === 0" class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                No articles to display. Create a selection first.
                            </div>

                            <template x-for="(article, index) in paginatedArticles" :key="article.id">
                                <div class="article-item">
                                    <div class="article-number" x-text="(articlesState.page - 1) * articlesState.pageSize + index + 1"></div>
                                    <div class="article-content">
                                        <div class="article-title-row">
                                            <h6 class="article-title" x-text="article.title && article.title.length > 120 ? article.title.substring(0, 120) + '...' : (article.title || 'Untitled')"></h6>
                                        </div>
                                        <div class="article-meta-row">
                                            <span class="article-feed" x-text="article.feed_title || 'Unknown Feed'"></span>
                                            <span class="article-date" x-text="article.published ? new Date(article.published).toLocaleString('de-DE', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'}) : 'No date'"></span>
                                        </div>
                                        <div x-show="article.description" class="article-description" x-text="article.description && article.description.length > 180 ? article.description.substring(0, 180) + '...' : article.description"></div>
                                        <div class="article-footer-row">
                                            <span x-show="article.has_analysis && article.sentiment_label" class="badge" :class="{
                                                'bg-success': article.sentiment_label && article.sentiment_label.toLowerCase() === 'positive',
                                                'bg-danger': article.sentiment_label && article.sentiment_label.toLowerCase() === 'negative',
                                                'bg-secondary': article.sentiment_label && article.sentiment_label.toLowerCase() !== 'positive' && article.sentiment_label.toLowerCase() !== 'negative'
                                            }">
                                                <small x-text="'✓ Analyzed: ' + (article.sentiment_label || 'Unknown')"></small>
                                            </span>
                                            <span x-show="!article.has_analysis" class="badge" style="background: #f59e0b;">
                                                <small>○ Not Analyzed</small>
                                            </span>
                                            <div class="article-actions">
                                                <a x-show="article.link" :href="article.link" target="_blank" class="btn-link">Read Article →</a>
                                                <span class="article-id" x-text="'#' + article.id"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <div x-show="paginatedArticles.length > 0" class="articles-footer">
                                <div class="pagination-info">
                                    <span x-text="'Showing ' + ((articlesState.page - 1) * articlesState.pageSize + 1) + '-' + Math.min(articlesState.page * articlesState.pageSize, filteredArticles.length) + ' of ' + filteredArticles.length + ' articles'"></span>
                                    <span class="separator">•</span>
                                    <span x-text="'Page ' + articlesState.page + ' of ' + totalFilteredPages"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script>
        function analysisControlV4() {
            return {
                futureRun: {
                    selection: {
                        mode: 'latest',
                        count: 50,
                        days: 7,
                        hours: 0,
                        feed_id: null
                    },
                    model: {
                        tag: 'gpt-4.1-nano',
                        rate_per_second: 1.0,
                        limit: 200
                    },
                    settings: {
                        override_existing: false
                    }
                },

                preview: {
                    total_items: 0,
                    already_analyzed_count: 0,
                    new_items_count: 0,
                    estimated_cost_usd: 0,
                    estimated_duration_minutes: 0
                },

                currentJobStatus: {
                    status: 'idle',
                    message: '',
                    id: null
                },

                pollIntervalId: null,

                availableFeeds: [],
                feedFilterEnabled: false,
                loading: false,
                selectionId: null,

                articlesState: {
                    full: [],
                    page: 1,
                    pageSize: 10
                },

                init() {
                    console.log('Alpine.js: analysisControlV4 initialized');
                    this.loadFeeds();
                    this.loadSavedState();

                    setTimeout(() => {
                        this.createSelection();
                    }, 100);
                },

                async loadFeeds() {
                    try {
                        const response = await fetch('/api/feeds-simple/list');
                        const data = await response.json();
                        this.availableFeeds = Array.isArray(data) ? data : [];
                        console.log('Loaded feeds:', this.availableFeeds.length);
                    } catch (error) {
                        console.error('Failed to load feeds:', error);
                        this.availableFeeds = [];
                    }
                },

                loadSavedState() {
                    try {
                        const saved = localStorage.getItem('futureRun_v4');
                        if (saved) {
                            this.futureRun = JSON.parse(saved);
                            if (this.futureRun.selection.feed_id) {
                                this.feedFilterEnabled = true;
                            }
                            console.log('Restored saved state from localStorage');
                        }

                        const selectionId = localStorage.getItem('selection_id');
                        if (selectionId) {
                            this.selectionId = selectionId;
                            console.log('Restored selection_id from localStorage:', selectionId);
                        }
                    } catch (error) {
                        console.error('Failed to load saved state:', error);
                    }
                },

                saveState() {
                    try {
                        localStorage.setItem('futureRun_v4', JSON.stringify(this.futureRun));
                    } catch (error) {
                        console.error('Failed to save state:', error);
                    }
                },

                setMode(mode) {
                    this.futureRun.selection.mode = mode;
                    this.articlePage = 1;
                    this.saveState();
                    this.createSelection();
                },

                async createSelection() {
                    console.log('Creating selection...');

                    // Map frontend mode to API mode
                    let apiMode = this.futureRun.selection.mode;
                    if (apiMode === 'timeRange') {
                        apiMode = 'time_range';
                    }

                    const request = {
                        mode: apiMode,
                        count: this.futureRun.selection.count,
                        feed_id: this.feedFilterEnabled && this.futureRun.selection.feed_id ? this.futureRun.selection.feed_id : null,
                        unanalyzed_only: !this.futureRun.settings.override_existing
                    };

                    if (this.futureRun.selection.mode === 'timeRange') {
                        const totalHours = (this.futureRun.selection.days || 0) * 24 + (this.futureRun.selection.hours || 0);
                        if (totalHours > 0) {
                            request.hours = totalHours;
                        }
                    }

                    try {
                        const response = await fetch('/api/analysis/selection', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(request)
                        });

                        if (!response.ok) {
                            console.error('Selection API failed:', response.statusText);
                            return;
                        }

                        const data = await response.json();
                        console.log('Selection created:', data);

                        this.selectionId = data.selection_id;
                        localStorage.setItem('selection_id', data.selection_id);

                        const limitedToAnalyze = Math.min(data.to_analyze, this.futureRun.model.limit);

                        this.preview = {
                            total_items: data.total_items,
                            already_analyzed_count: data.already_analyzed,
                            new_items_count: limitedToAnalyze,
                            estimated_cost_usd: (limitedToAnalyze * 0.0001),
                            estimated_duration_minutes: Math.max(1, Math.floor(limitedToAnalyze / 60))
                        };

                        console.log('Selection ID set to:', this.selectionId);

                        await this.loadArticlesIntoState();

                    } catch (error) {
                        console.error('Error creating selection:', error);
                    }
                },

                async loadArticlesIntoState() {
                    if (!this.selectionId) {
                        console.warn('No selection ID available');
                        return;
                    }

                    try {
                        console.log('Loading articles into state for selection:', this.selectionId);
                        const response = await fetch(`/api/analysis/selection/${this.selectionId}/articles`);

                        if (!response.ok) {
                            console.error('Failed to load articles:', response.statusText);
                            return;
                        }

                        const data = await response.json();
                        this.articlesState.full = data.articles || [];
                        this.articlesState.page = 1;

                        console.log('Articles loaded into state:', this.articlesState.full.length);
                    } catch (error) {
                        console.error('Error loading articles into state:', error);
                    }
                },

                updatePreviewFromLimit() {
                    console.log('Updating preview from limit change:', this.futureRun.model.limit);

                    if (this.preview.total_items > 0) {
                        const toAnalyze = this.preview.total_items - this.preview.already_analyzed_count;
                        const limitedToAnalyze = Math.min(toAnalyze, this.futureRun.model.limit);

                        this.preview.new_items_count = limitedToAnalyze;
                        this.preview.estimated_cost_usd = limitedToAnalyze * 0.0001;
                        this.preview.estimated_duration_minutes = Math.max(1, Math.floor(limitedToAnalyze / 60));

                        console.log('Preview updated:', this.preview);
                    }
                },


                async startRun() {
                    console.log('Starting analysis run...');
                    this.loading = true;

                    try {
                        const response = await fetch('/api/v1/analysis/runs', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                scope: this.buildScope(),
                                params: this.buildParams()
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Failed to start analysis run');
                        }

                        const run = await response.json();
                        console.log('Run started:', run);

                        this.currentJobStatus = {
                            status: 'running',
                            message: `Analyzing ${run.total_items || this.preview.new_items_count} articles...`,
                            id: run.id || run.run_id
                        };

                        this.pollRunStatus(run.id || run.run_id);

                    } catch (error) {
                        console.error('Error starting run:', error);
                        this.currentJobStatus = {
                            status: 'error',
                            message: error.message,
                            id: null
                        };
                    } finally {
                        this.loading = false;
                    }
                },

                pollRunStatus(runId) {
                    this.pollIntervalId = setInterval(async () => {
                        const pollInterval = this.pollIntervalId;
                        try {
                            const response = await fetch(`/api/v1/analysis/runs/${runId}`);
                            const run = await response.json();

                            console.log('Poll status:', run.status);

                            if (run.status === 'completed' || run.status === 'failed' || run.status === 'cancelled') {
                                clearInterval(pollInterval);
                                this.pollIntervalId = null;

                                this.currentJobStatus = {
                                    status: run.status === 'completed' ? 'done' : (run.status === 'cancelled' ? 'cancelled' : 'error'),
                                    message: run.status === 'completed'
                                        ? `Completed! Processed ${run.processed_count || run.total_items} items.`
                                        : run.status === 'cancelled'
                                        ? 'Run cancelled'
                                        : 'Analysis run failed',
                                    id: runId
                                };

                                setTimeout(() => {
                                    this.currentJobStatus = { status: 'idle', message: '', id: null };
                                    this.updatePreview();
                                }, 5000);
                            }
                        } catch (error) {
                            console.error('Error polling run status:', error);
                            clearInterval(pollInterval);
                            this.pollIntervalId = null;
                        }
                    }, 3000);
                },

                async cancelRun() {
                    if (!this.currentJobStatus.id) {
                        console.warn('No active run to cancel');
                        return;
                    }

                    const runId = this.currentJobStatus.id;

                    try {
                        const response = await fetch(`/api/v1/analysis/runs/${runId}`, {
                            method: 'DELETE'
                        });

                        if (!response.ok) {
                            throw new Error('Failed to cancel run');
                        }

                        const result = await response.json();
                        console.log('Run cancelled:', result);

                        if (this.pollIntervalId) {
                            clearInterval(this.pollIntervalId);
                            this.pollIntervalId = null;
                        }

                        this.currentJobStatus = {
                            status: 'cancelled',
                            message: `Run ${runId} cancelled`,
                            id: null
                        };

                        setTimeout(() => {
                            this.currentJobStatus = { status: 'idle', message: '', id: null };
                        }, 3000);

                    } catch (error) {
                        console.error('Error cancelling run:', error);
                    }
                },

                buildScope() {
                    const scope = {
                        type: 'global',
                        feed_ids: [],
                        unanalyzed_only: !this.futureRun.settings.override_existing
                    };

                    if (this.futureRun.selection.mode === 'latest') {
                        scope.type = 'global';
                    } else if (this.futureRun.selection.mode === 'timeRange') {
                        scope.type = 'timerange';
                        const totalHours = (this.futureRun.selection.days || 0) * 24 + (this.futureRun.selection.hours || 0);
                        if (totalHours > 0) {
                            const endTime = new Date();
                            const startTime = new Date(endTime.getTime() - totalHours * 60 * 60 * 1000);
                            scope.start_time = startTime.toISOString();
                            scope.end_time = endTime.toISOString();
                        }
                    } else if (this.futureRun.selection.mode === 'unanalyzed') {
                        scope.type = 'global';
                        scope.unanalyzed_only = true;
                    }

                    if (this.feedFilterEnabled && this.futureRun.selection.feed_id) {
                        scope.feed_ids = [parseInt(this.futureRun.selection.feed_id)];
                        scope.type = 'feeds';
                    }

                    return scope;
                },

                buildParams() {
                    const unanalyzedCount = this.filteredArticles.length;
                    const effectiveLimit = Math.min(unanalyzedCount, this.futureRun.model.limit);

                    return {
                        model_tag: this.futureRun.model.tag,
                        rate_per_second: this.futureRun.model.rate_per_second,
                        limit: effectiveLimit,
                        override_existing: this.futureRun.settings.override_existing,
                        newest_first: true
                    };
                },

                get filteredArticles() {
                    if (!this.articlesState.full || this.articlesState.full.length === 0) {
                        return [];
                    }

                    const unanalyzed = this.articlesState.full.filter(a => !a.has_analysis);
                    const limit = this.futureRun.model.limit || 10000;
                    return unanalyzed.slice(0, limit);
                },

                get paginatedArticles() {
                    const filtered = this.filteredArticles;
                    const offset = (this.articlesState.page - 1) * this.articlesState.pageSize;
                    return filtered.slice(offset, offset + this.articlesState.pageSize);
                },

                get totalFilteredPages() {
                    const filtered = this.filteredArticles;
                    return Math.ceil(filtered.length / this.articlesState.pageSize);
                }
            }
        }
    </script>
</div>
{% endblock %}
