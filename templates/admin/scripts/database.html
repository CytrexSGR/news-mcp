<script>
let tablesData = [];
let queryHistory = JSON.parse(localStorage.getItem('queryHistory') || '[]');
let currentResults = null;

// Load initial data
document.addEventListener('DOMContentLoaded', function() {
    loadTables();
    loadQuickQueries();
    displayQueryHistory();
});

async function loadTables() {
    try {
        const response = await fetch('/api/database/tables');
        const data = await response.json();
        tablesData = data.tables;
        renderTables();
    } catch (error) {
        console.error('Error loading tables:', error);
        document.getElementById('tables-list').innerHTML =
            '<div class="alert alert-danger m-2">Error loading tables</div>';
    }
}

function renderTables() {
    const container = document.getElementById('tables-list');
    let html = '';

    tablesData.forEach(table => {
        html += `
            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                 onclick="selectTable('${table.name}')" style="cursor: pointer;">
                <div>
                    <i class="fas fa-table text-primary"></i>
                    <strong>${table.name}</strong>
                    <br>
                    <small class="text-muted">${table.row_count.toLocaleString()} rows</small>
                </div>
                <button class="btn btn-sm btn-outline-secondary"
                        onclick="event.stopPropagation(); quickSelect('${table.name}')"
                        title="Quick SELECT">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        `;
    });

    container.innerHTML = html;
}

async function selectTable(tableName) {
    try {
        const response = await fetch(`/api/database/schema/${tableName}`);
        const data = await response.json();

        let schemaHtml = `<h6>${tableName}</h6>`;
        schemaHtml += '<div class="table-responsive"><table class="table table-sm">';
        schemaHtml += '<thead><tr><th>Column</th><th>Type</th><th>Nullable</th></tr></thead><tbody>';

        data.columns.forEach(col => {
            const nullable = col.nullable ? 'âœ“' : '';
            schemaHtml += `
                <tr>
                    <td><strong>${col.name}</strong></td>
                    <td><span class="column-type">${col.type}</span></td>
                    <td>${nullable}</td>
                </tr>
            `;
        });

        schemaHtml += '</tbody></table></div>';

        document.getElementById('schema-info').innerHTML = schemaHtml;
        document.getElementById('schema-card').style.display = 'block';
    } catch (error) {
        console.error('Error loading schema:', error);
    }
}

function quickSelect(tableName) {
    const query = `SELECT * FROM ${tableName} LIMIT 10;`;
    document.getElementById('sql-query').value = query;

    if (document.getElementById('auto-execute').checked) {
        executeQuery();
    }
}

async function loadQuickQueries() {
    try {
        const response = await fetch('/api/database/quick-queries');
        const data = await response.json();

        let html = '';
        data.queries.forEach(query => {
            html += `
                <button class="btn btn-outline-primary quick-query-btn"
                        onclick="loadQuickQuery('${query.name}')"
                        title="${query.description}">
                    ${query.name}
                </button>
            `;
        });

        document.getElementById('quick-queries').innerHTML = html;

        // Store queries for later use
        window.quickQueries = data.queries;
    } catch (error) {
        console.error('Error loading quick queries:', error);
        document.getElementById('quick-queries').innerHTML =
            '<div class="alert alert-danger">Error loading quick queries</div>';
    }
}

function loadQuickQuery(name) {
    const query = window.quickQueries.find(q => q.name === name);
    if (query) {
        document.getElementById('sql-query').value = query.query;

        if (document.getElementById('auto-execute').checked) {
            executeQuery();
        }
    }
}

async function executeQuery() {
    const form = document.getElementById('query-form');
    const formData = new FormData(form);
    const query = formData.get('query').trim();

    if (!query) {
        showStatus('Please enter a query', 'warning');
        return;
    }

    showStatus('Executing query...', 'info');
    document.getElementById('export-csv-btn').disabled = true;
    document.getElementById('export-json-btn').disabled = true;

    try {
        const response = await fetch('/api/database/query', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            currentResults = result;
            displayResults(result);
            addToHistory(query, result);
            document.getElementById('export-csv-btn').disabled = false;
            document.getElementById('export-json-btn').disabled = false;
        } else {
            showStatus(`Query Error: ${result.error}`, 'danger');
            document.getElementById('query-results').style.display = 'none';
        }
    } catch (error) {
        console.error('Error executing query:', error);
        showStatus('Network error occurred', 'danger');
    }
}

function displayResults(result) {
    const container = document.getElementById('query-results');

    if (result.data.length === 0) {
        container.innerHTML = '<div class="alert alert-info">Query executed successfully but returned no results.</div>';
        showStatus(`Query executed successfully - 0 rows returned`, 'success');
    } else {
        let html = '<table class="table table-striped table-hover result-table"><thead class="table-dark"><tr>';

        // Headers
        result.columns.forEach(col => {
            html += `<th>${col}</th>`;
        });
        html += '</tr></thead><tbody>';

        // Rows
        result.data.forEach(row => {
            html += '<tr>';
            result.columns.forEach(col => {
                let value = row[col];
                if (value === null) {
                    value = '<span class="text-muted">NULL</span>';
                } else if (typeof value === 'string' && value.length > 100) {
                    value = value.substring(0, 100) + '...';
                }
                html += `<td>${value}</td>`;
            });
            html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;

        showStatus(`Query executed successfully - ${result.row_count} rows returned`, 'success');
    }

    container.style.display = 'block';
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('query-status');
    statusDiv.className = `alert alert-${type}`;
    statusDiv.innerHTML = `<i class="fas fa-${getStatusIcon(type)}"></i> ${message}`;
    statusDiv.style.display = 'block';
}

function getStatusIcon(type) {
    const icons = {
        'info': 'info-circle',
        'success': 'check-circle',
        'warning': 'exclamation-triangle',
        'danger': 'exclamation-circle'
    };
    return icons[type] || 'info-circle';
}

function addToHistory(query, result) {
    const historyItem = {
        query: query,
        timestamp: new Date().toISOString(),
        rowCount: result.row_count,
        success: result.success
    };

    queryHistory.unshift(historyItem);
    if (queryHistory.length > 50) {
        queryHistory = queryHistory.slice(0, 50);
    }

    localStorage.setItem('queryHistory', JSON.stringify(queryHistory));
    displayQueryHistory();
}

function displayQueryHistory() {
    const container = document.getElementById('query-history');

    if (queryHistory.length === 0) {
        container.innerHTML = '<div class="text-muted">No queries executed yet.</div>';
        return;
    }

    let html = '';
    queryHistory.slice(0, 10).forEach((item, index) => {
        const time = new Date(item.timestamp).toLocaleString();
        const statusIcon = item.success ? 'check-circle text-success' : 'exclamation-circle text-danger';

        html += `
            <div class="border rounded p-2 mb-2" style="cursor: pointer;"
                 onclick="loadFromHistory(${index})">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <code class="small">${item.query.substring(0, 80)}${item.query.length > 80 ? '...' : ''}</code>
                    </div>
                    <div class="text-end">
                        <i class="fas fa-${statusIcon}"></i>
                        <small class="text-muted">${time}</small>
                    </div>
                </div>
                <div class="query-stats mt-1">
                    <small>Returned ${item.rowCount} rows</small>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function loadFromHistory(index) {
    const item = queryHistory[index];
    document.getElementById('sql-query').value = item.query;
}

function clearEditor() {
    document.getElementById('sql-query').value = '';
    document.getElementById('query-results').style.display = 'none';
    showStatus('Enter a SELECT query above and click Execute to see results.', 'info');
}

function formatQuery() {
    const textarea = document.getElementById('sql-query');
    let query = textarea.value;

    // Simple query formatting
    query = query.replace(/\s+/g, ' ');
    query = query.replace(/\s*,\s*/g, ',\n  ');
    query = query.replace(/\s+FROM\s+/gi, '\nFROM ');
    query = query.replace(/\s+WHERE\s+/gi, '\nWHERE ');
    query = query.replace(/\s+ORDER\s+BY\s+/gi, '\nORDER BY ');
    query = query.replace(/\s+GROUP\s+BY\s+/gi, '\nGROUP BY ');
    query = query.replace(/\s+LIMIT\s+/gi, '\nLIMIT ');

    textarea.value = query;
}

function clearHistory() {
    queryHistory = [];
    localStorage.removeItem('queryHistory');
    displayQueryHistory();
}

function refreshTables() {
    loadTables();
}

function exportResults(format) {
    if (!currentResults) return;

    if (format === 'csv') {
        let csv = currentResults.columns.join(',') + '\n';
        currentResults.data.forEach(row => {
            const values = currentResults.columns.map(col => {
                let value = row[col];
                if (value === null) value = '';
                if (typeof value === 'string' && value.includes(',')) {
                    value = `"${value}"`;
                }
                return value;
            });
            csv += values.join(',') + '\n';
        });

        downloadFile(csv, 'query_results.csv', 'text/csv');
    } else if (format === 'json') {
        const json = JSON.stringify(currentResults.data, null, 2);
        downloadFile(json, 'query_results.json', 'application/json');
    }
}

function downloadFile(content, filename, contentType) {
    const blob = new Blob([content], { type: contentType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        executeQuery();
    }
});
</script>
