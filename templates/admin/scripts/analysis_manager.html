<script>
// Load feeds for selection
async function loadFeeds() {
    try {
        const response = await fetch('/api/feeds/');
        const data = await response.json();
        const select = document.getElementById('feed-select');

        if (Array.isArray(data)) {
            data.forEach(feed => {
                const option = document.createElement('option');
                option.value = feed.id;
                option.textContent = `${feed.title || 'Untitled'} (ID: ${feed.id})`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading feeds:', error);
    }
}

// Load metrics for specific feed
async function loadFeedMetrics(feedId) {
    if (!feedId) {
        document.getElementById('feed-metrics').innerHTML =
            '<div class="placeholder text-center py-4 text-muted">Select a feed to view metrics</div>';
        return;
    }

    document.getElementById('feed-metrics').innerHTML =
        '<div class="loading text-center py-4 text-muted">Loading feed metrics...</div>';

    try {
        const response = await fetch(`/api/metrics/feeds/${feedId}/summary`);
        const data = await response.json();

        if (data.success && data.data) {
            displayFeedMetrics(data.data);
        } else {
            throw new Error(data.error || 'Failed to load metrics');
        }
    } catch (error) {
        document.getElementById('feed-metrics').innerHTML =
            `<div class="alert alert-danger">Error loading metrics: ${error.message}</div>`;
    }
}

// Display feed metrics
function displayFeedMetrics(metrics) {
    const today = metrics.today;
    const lastWeek = metrics.last_7_days;

    let html = `<h6 class="mb-3">${metrics.feed_name || 'Unknown'}</h6>`;

    html += `
        <div class="row g-3">
            <div class="col-md-6">
                <div class="card bg-dark">
                    <div class="card-body">
                        <h6 class="card-title">📊 Today's Stats</h6>
                        ${today ? `
                            <div class="d-flex justify-content-between mb-2">
                                <span>Analyses:</span>
                                <strong>${today.analysis_counts.total}</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Items Processed:</span>
                                <strong>${today.item_counts.total_processed}</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Success Rate:</span>
                                <strong>${today.performance.success_rate.toFixed(1)}%</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Cost:</span>
                                <strong>$${today.costs.total_usd.toFixed(4)}</strong>
                            </div>
                        ` : '<p class="text-muted">No data for today</p>'}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-dark">
                    <div class="card-body">
                        <h6 class="card-title">📈 Last 7 Days</h6>
                        ${lastWeek ? `
                            <div class="d-flex justify-content-between mb-2">
                                <span>Total Analyses:</span>
                                <strong>${lastWeek.total_analyses}</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Total Items:</span>
                                <strong>${lastWeek.total_items}</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Avg Success Rate:</span>
                                <strong>${lastWeek.avg_success_rate.toFixed(1)}%</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Total Cost:</span>
                                <strong>$${lastWeek.total_cost_usd.toFixed(4)}</strong>
                            </div>
                        ` : '<p class="text-muted">No data available</p>'}
                    </div>
                </div>
            </div>
        </div>
    `;

    document.getElementById('feed-metrics').innerHTML = html;
}

// Load cost breakdown
async function loadCostBreakdown(days) {
    document.getElementById('cost-breakdown').innerHTML =
        '<div class="loading text-center py-4 text-muted">Loading cost data...</div>';

    try {
        const response = await fetch(`/api/metrics/costs/breakdown?days=${days}`);
        const data = await response.json();

        if (data.success && data.data) {
            displayCostBreakdown(data.data);
        } else {
            throw new Error(data.error || 'Failed to load cost data');
        }
    } catch (error) {
        document.getElementById('cost-breakdown').innerHTML =
            `<div class="alert alert-danger">Error loading costs: ${error.message}</div>`;
    }
}

// Display cost breakdown
function displayCostBreakdown(data) {
    const breakdown = data.breakdown;

    let html = `
        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <div class="card bg-dark text-center">
                    <div class="card-body">
                        <small class="text-muted">Total Analyses</small>
                        <h5 class="mb-0">${breakdown.system_totals?.total_analyses || 0}</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-dark text-center">
                    <div class="card-body">
                        <small class="text-muted">Total Cost</small>
                        <h5 class="mb-0">$${(breakdown.system_totals?.total_cost_usd || 0).toFixed(4)}</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-dark text-center">
                    <div class="card-body">
                        <small class="text-muted">Active Feeds</small>
                        <h5 class="mb-0">${breakdown.system_totals?.active_feeds || 0}</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-dark text-center">
                    <div class="card-body">
                        <small class="text-muted">Items Processed</small>
                        <h5 class="mb-0">${breakdown.system_totals?.total_items || 0}</h5>
                    </div>
                </div>
            </div>
        </div>
    `;

    if (breakdown.top_spending_feeds && breakdown.top_spending_feeds.length > 0) {
        html += `
            <h6 class="mb-3">🔥 Top Spending Feeds</h6>
            <div class="list-group">
        `;

        breakdown.top_spending_feeds.forEach(feed => {
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span>Feed ${feed.feed_id}</span>
                    <span class="badge bg-primary rounded-pill">$${feed.cost_usd.toFixed(4)}</span>
                </div>
            `;
        });

        html += `</div>`;
    }

    document.getElementById('cost-breakdown').innerHTML = html;
}

// HTMX response handler for system overview and queue performance
document.body.addEventListener('htmx:afterRequest', function(evt) {
    const target = evt.detail.target;

    // System Overview handler
    if (target && target.parentElement &&
        target.parentElement.querySelector('[hx-get="/api/metrics/system/overview"]')) {
        try {
            const data = JSON.parse(evt.detail.xhr.responseText);
            if (data.success && data.data) {
                displaySystemOverview(target, data.data);
            }
        } catch (error) {
            console.error('Error parsing system overview:', error);
        }
    }

    // Queue Performance handler
    if (target && target.id === 'queue-performance') {
        try {
            const data = JSON.parse(evt.detail.xhr.responseText);
            if (data.success && data.data) {
                displayQueuePerformance(data.data);
            }
        } catch (error) {
            target.innerHTML = '<div class="alert alert-danger">Error parsing queue performance</div>';
        }
    }
});

// Display system overview in card
function displaySystemOverview(target, data) {
    const totals = data.system_totals;
    const queue = data.queue_performance;

    let html = `
        <div class="card-body">
            <h6 class="card-title mb-3">📊 System Overview</h6>
            <div class="d-flex justify-content-between mb-2">
                <small class="text-muted">Analyses Today:</small>
                <strong>${totals?.total_analyses || 0}</strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
                <small class="text-muted">Items Processed:</small>
                <strong>${totals?.total_items || 0}</strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
                <small class="text-muted">Avg Time:</small>
                <strong>${(queue?.avg_queue_time_seconds || 0).toFixed(1)}s</strong>
            </div>
            <div class="d-flex justify-content-between">
                <small class="text-muted">Cost Today:</small>
                <strong class="text-success">$${(totals?.total_cost_usd || 0).toFixed(4)}</strong>
            </div>
        </div>
    `;

    target.innerHTML = html;
}

// Display queue performance
function displayQueuePerformance(data) {
    document.getElementById('queue-performance').innerHTML = `
        <div class="text-center py-4">
            <p class="mb-2">${data.message || 'Queue performance monitoring is active'}</p>
            <small class="text-muted">Queue metrics will be available once processing begins</small>
        </div>
    `;
}

// Storage Statistics Functions
async function loadStorageStats() {
    try {
        const response = await fetch('/api/metrics/storage/stats');
        const result = await response.json();

        if (result.success && result.data) {
            displayStorageStats(result.data);
        } else {
            throw new Error(result.error || 'Failed to load storage stats');
        }
    } catch (error) {
        document.getElementById('storage-stats-content').innerHTML =
            `<div class="alert alert-danger p-2 m-0"><small>Error: ${error.message}</small></div>`;
    }
}

function displayStorageStats(data) {
    const content = document.getElementById('storage-stats-content');

    let html = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="card-title mb-0">💾 Storage Stats</h6>
            <button class="btn btn-sm btn-outline-primary" onclick="loadStorageStats()" title="Refresh">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        <div class="d-flex justify-content-between mb-2">
            <small class="text-muted">Database Size:</small>
            <strong>${data.database_size}</strong>
        </div>
        <div class="d-flex justify-content-between mb-2">
            <small class="text-muted">Total Items:</small>
            <strong>${data.item_count.toLocaleString()}</strong>
        </div>
        <div class="d-flex justify-content-between mb-2">
            <small class="text-muted">Analyzed:</small>
            <strong>${data.analysis_count.toLocaleString()} (${data.analysis_coverage_percent}%)</strong>
        </div>
        <div class="d-flex justify-content-between mb-2">
            <small class="text-muted">Growth:</small>
            <strong>${data.growth.items_per_week.toLocaleString()}/week</strong>
        </div>
        <div class="mt-2">
            <button class="btn btn-sm btn-info w-100" onclick="toggleStorageDetails()">
                <i class="fas fa-chart-bar"></i> Details
            </button>
        </div>
    `;

    content.innerHTML = html;
}

function toggleStorageDetails() {
    const detailsCard = document.getElementById('storage-details');
    const isVisible = detailsCard.style.display !== 'none';

    if (isVisible) {
        detailsCard.style.display = 'none';
    } else {
        detailsCard.style.display = 'block';
        loadStorageDetails();
    }
}

async function loadStorageDetails() {
    const detailsContent = document.getElementById('storage-details-content');
    detailsContent.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Loading details...</div>';

    try {
        const response = await fetch('/api/metrics/storage/stats');
        const result = await response.json();

        if (result.success && result.data) {
            displayStorageDetails(result.data);
        } else {
            throw new Error(result.error || 'Failed to load storage details');
        }
    } catch (error) {
        detailsContent.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    }
}

function displayStorageDetails(data) {
    const detailsContent = document.getElementById('storage-details-content');

    let html = `
        <div class="row g-3">
            <!-- Category Breakdown -->
            <div class="col-md-6">
                <h6>📊 Storage by Category</h6>
                <div class="list-group">
    `;

    data.category_sizes.forEach(cat => {
        const percentage = (cat.bytes / (data.top_tables[0]?.total_bytes || 1) * 100).toFixed(1);
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <span>${cat.category}</span>
                <div class="text-end">
                    <strong>${cat.size}</strong>
                    <br><small class="text-muted">${percentage}%</small>
                </div>
            </div>
        `;
    });

    html += `
                </div>
            </div>

            <!-- Top Tables -->
            <div class="col-md-6">
                <h6>🗃️ Top 5 Tables</h6>
                <div class="list-group">
    `;

    data.top_tables.slice(0, 5).forEach(table => {
        html += `
            <div class="list-group-item">
                <div class="d-flex justify-content-between">
                    <strong>${table.name}</strong>
                    <span class="badge bg-primary">${table.total_size}</span>
                </div>
                <small class="text-muted">Table: ${table.table_size} | Indexes: ${table.indexes_size}</small>
            </div>
        `;
    });

    html += `
                </div>
            </div>

            <!-- Growth Stats -->
            <div class="col-md-6">
                <h6>📈 Growth Statistics</h6>
                <div class="card bg-dark">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total Items:</span>
                            <strong>${data.growth.total_items.toLocaleString()}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Items/Week:</span>
                            <strong>${data.growth.items_per_week.toLocaleString()}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Est. Items/Year:</span>
                            <strong>${data.growth.estimated_items_per_year_k}k</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Data Age:</span>
                            <strong>${data.growth.data_age_days} days</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Data -->
            <div class="col-md-6">
                <h6>🧠 Analysis Data</h6>
                <div class="card bg-dark">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total Analyses:</span>
                            <strong>${data.analysis_count.toLocaleString()}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Coverage:</span>
                            <strong>${data.analysis_coverage_percent}%</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Geopolitical:</span>
                            <strong>${data.geopolitical.with_geopolitical.toLocaleString()} (${data.geopolitical.percentage}%)</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Geo Size:</span>
                            <strong>${data.geopolitical.size}</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- JSONB Field Sizes -->
            <div class="col-md-12">
                <h6>📦 JSONB Field Sizes</h6>
                <div class="row g-2">
    `;

    data.jsonb_fields.forEach(field => {
        html += `
            <div class="col-md-6">
                <div class="card bg-dark">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between">
                            <strong>${field.field_type}</strong>
                            <span class="badge bg-secondary">${field.total_size}</span>
                        </div>
                        <small class="text-muted">${field.entries.toLocaleString()} entries • Avg: ${field.avg_size}</small>
                    </div>
                </div>
            </div>
        `;
    });

    html += `
                </div>
            </div>
        </div>
    `;

    detailsContent.innerHTML = html;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadFeeds();
    loadCostBreakdown(7);
    loadStorageStats();  // Load storage stats on page load
});
</script>

