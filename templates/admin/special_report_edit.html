{% extends "base.html" %}

{% block title %}Edit Special Report{% endblock %}

{% block content %}
<style>
    .split-view {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        height: calc(100vh - 120px);
        overflow: hidden;
    }

    .config-panel, .preview-panel {
        background: var(--bs-dark);
        border-radius: 8px;
        padding: 20px;
        overflow-y: auto;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sticky-header {
        position: sticky;
        top: -20px;
        background: var(--bs-dark);
        z-index: 10;
        padding: 10px 0 20px 0;
        margin: -10px 0 20px 0;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }

    .section-divider {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        margin: 30px 0;
    }

    .btn-test {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        font-weight: 600;
    }

    .btn-test:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }

    .test-results {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 6px;
        padding: 15px;
        margin-top: 15px;
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 0.9em;
    }

    .article-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
        border-left: 3px solid #667eea;
    }

    .badge-metric {
        font-size: 0.75em;
        padding: 4px 8px;
        border-radius: 4px;
    }

    .form-label {
        font-weight: 600;
        color: #a0aec0;
        font-size: 0.85em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .form-control, .form-select {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
    }

    .form-control:focus, .form-select:focus {
        background: rgba(0, 0, 0, 0.4);
        border-color: #667eea;
        color: white;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    textarea.form-control {
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 0.9em;
    }

    .feed-select-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
        background: rgba(0, 0, 0, 0.2);
        padding: 12px;
        border-radius: 6px;
    }

    .form-check {
        background: rgba(255, 255, 255, 0.05);
        padding: 8px 12px;
        border-radius: 4px;
    }

    .loading-spinner {
        display: none;
    }

    .loading .loading-spinner {
        display: inline-block;
    }

    @media (max-width: 1200px) {
        .split-view {
            grid-template-columns: 1fr;
            height: auto;
        }

        .preview-panel {
            margin-top: 20px;
        }
    }
</style>

<div class="container-fluid">
    <!-- Top Navigation -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="/admin/special-reports" class="text-decoration-none text-secondary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
            <h2 class="mt-2 mb-0">
                <i class="fas fa-edit text-warning"></i>
                Edit: {{ special_report.name }}
            </h2>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                <i class="fas fa-undo"></i> Reset
            </button>
            <button type="submit" form="edit-form" class="btn btn-success">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>
    </div>

    <!-- Split View Layout -->
    <div class="split-view">
        <!-- Left Panel: Configuration -->
        <div class="config-panel">
            <div class="sticky-header">
                <h4 class="text-light mb-0">
                    <i class="fas fa-cog"></i> Configuration
                </h4>
            </div>

            <form id="edit-form"
                  hx-put="/htmx/special_reports/{{ special_report.id }}/update"
                  hx-target="#save-status"
                  hx-swap="innerHTML">

                <!-- Basic Information -->
                <div class="mb-4">
                    <h6 class="text-info mb-3">
                        <i class="fas fa-info-circle"></i> Basic Information
                    </h6>

                    <div class="mb-3">
                        <label class="form-label">Report Name</label>
                        <input type="text" name="name" class="form-control"
                               value="{{ special_report.name }}" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="2"
                                  placeholder="What is this report about?">{{ special_report.description or '' }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Target Audience</label>
                        <input type="text" name="target_audience" class="form-control"
                               value="{{ special_report.target_audience or '' }}"
                               placeholder="e.g., IT Managers, Security Teams, C-Level">
                    </div>

                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="is_active"
                               id="is_active" {% if special_report.is_active %}checked{% endif %}>
                        <label class="form-check-label" for="is_active">
                            Active (enable generation)
                        </label>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- LLM Configuration -->
                <div class="mb-4">
                    <h6 class="text-warning mb-3">
                        <i class="fas fa-brain"></i> LLM Configuration
                    </h6>

                    <div class="mb-3">
                        <label class="form-label">Model</label>
                        <select name="llm_model" class="form-select">
                            <option value="gpt-4o" {% if special_report.llm_model == 'gpt-4o' %}selected{% endif %}>
                                GPT-4o (Best quality, ~$0.10/report)
                            </option>
                            <option value="gpt-4o-mini" {% if special_report.llm_model == 'gpt-4o-mini' %}selected{% endif %}>
                                GPT-4o-mini (Balanced, ~$0.02/report)
                            </option>
                            <option value="gpt-3.5-turbo" {% if special_report.llm_model == 'gpt-3.5-turbo' %}selected{% endif %}>
                                GPT-3.5 Turbo (Fast, ~$0.003/report)
                            </option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Custom Prompt Template (Optional)</label>
                        <textarea name="prompt_template" class="form-control" rows="6"
                                  placeholder="Leave empty for default template. Variables: {target_audience}, {article_count}, {timeframe}, {articles}">{{ special_report.prompt_template or '' }}</textarea>
                        <small class="text-muted">
                            Available variables: {target_audience}, {article_count}, {timeframe}, {articles}
                        </small>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Article Selection Criteria -->
                <div class="mb-4">
                    <h6 class="text-success mb-3">
                        <i class="fas fa-filter"></i> Article Selection
                    </h6>

                    <div class="mb-3">
                        <label class="form-label">Feed Sources ({{ feeds|length }} available)</label>
                        <div class="feed-select-grid">
                            {% for feed in feeds[:30] %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="feed_ids"
                                       value="{{ feed.id }}" id="feed_{{ feed.id }}"
                                       {% if feed.id in selected_feed_ids %}checked{% endif %}>
                                <label class="form-check-label" for="feed_{{ feed.id }}">
                                    {{ feed.title or feed.url[:40] }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        {% if feeds|length > 30 %}
                        <small class="text-muted">Showing first 30 feeds. Select from these or adjust filter.</small>
                        {% endif %}
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Timeframe (hours)</label>
                            <input type="number" name="timeframe_hours" class="form-control"
                                   value="{{ selection_criteria.get('timeframe_hours', 24) }}" min="1">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Max Articles</label>
                            <input type="number" name="max_articles" class="form-control"
                                   value="{{ selection_criteria.get('max_articles', 20) }}" min="1" max="100">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Min Impact Score (0-1)</label>
                            <input type="number" name="min_impact_score" class="form-control"
                                   value="{{ selection_criteria.get('min_impact_score', 0.0) }}"
                                   step="0.1" min="0" max="1">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Min Sentiment (-1 to 1)</label>
                            <input type="number" name="min_sentiment_score" class="form-control"
                                   value="{{ selection_criteria.get('min_sentiment_score', -1.0) }}"
                                   step="0.1" min="-1" max="1">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Include Keywords (comma-separated)</label>
                        <input type="text" name="keywords" class="form-control"
                               value="{{ keywords_str }}"
                               placeholder="security, breach, vulnerability">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Exclude Keywords (comma-separated)</label>
                        <input type="text" name="exclude_keywords" class="form-control"
                               value="{{ exclude_keywords_str }}"
                               placeholder="spam, advertisement">
                    </div>
                </div>

                <div id="save-status" class="mt-3"></div>
            </form>
        </div>

        <!-- Right Panel: Live Preview/Test -->
        <div class="preview-panel">
            <div class="sticky-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="text-light mb-0">
                        <i class="fas fa-vial"></i> Live Test
                    </h4>
                    <button type="button" class="btn btn-test" onclick="runTest()">
                        <i class="fas fa-play"></i> Test Selection
                        <span class="loading-spinner spinner-border spinner-border-sm ms-2"></span>
                    </button>
                </div>
            </div>

            <div id="test-results">
                <div class="text-center text-muted py-5">
                    <i class="fas fa-flask fa-3x mb-3"></i>
                    <p>Click "Test Selection" to preview which articles would be selected with current criteria.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function runTest() {
        const btn = document.querySelector('.btn-test');
        btn.classList.add('loading');

        // Collect form data
        const formData = new FormData(document.getElementById('edit-form'));

        // Send test request
        fetch('/htmx/special_reports/{{ special_report.id }}/test', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(html => {
            document.getElementById('test-results').innerHTML = html;
            btn.classList.remove('loading');
        })
        .catch(error => {
            document.getElementById('test-results').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Test failed: ${error.message}
                </div>
            `;
            btn.classList.remove('loading');
        });
    }

    function resetForm() {
        if (confirm('Reset all changes? This will reload the page.')) {
            window.location.reload();
        }
    }

    // Auto-save indicator
    document.getElementById('edit-form').addEventListener('submit', function() {
        document.getElementById('save-status').innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin"></i> Saving...
            </div>
        `;
    });

    // HTMX success handler
    document.body.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.target.id === 'save-status') {
            if (event.detail.successful) {
                document.getElementById('save-status').innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check"></i> Changes saved successfully!
                    </div>
                `;
                setTimeout(() => {
                    document.getElementById('save-status').innerHTML = '';
                }, 3000);
            }
        }
    });
</script>
{% endblock %}
