{% extends "base.html" %}

{% block title %}Articles - News MCP{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Articles Stream</h1>
    <div class="btn-group" role="group">
        <button class="btn btn-outline-primary"
                hx-get="/htmx/items-list"
                hx-include="[name='search'], [name='category_id'], [name='feed_id']"
                hx-vals='{"since_hours": "1"}'
                hx-target="#items-list">
            Last Hour
        </button>
        <button class="btn btn-outline-primary"
                hx-get="/htmx/items-list"
                hx-include="[name='search'], [name='category_id'], [name='feed_id']"
                hx-vals='{"since_hours": "24"}'
                hx-target="#items-list">
            Today
        </button>
        <button class="btn btn-outline-primary"
                hx-get="/htmx/items-list"
                hx-include="[name='search'], [name='category_id'], [name='feed_id']"
                hx-vals='{"since_hours": "168"}'
                hx-target="#items-list">
            This Week
        </button>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <input type="text" class="form-control" placeholder="Search articles..." name="search"
               hx-get="/htmx/items-list" hx-trigger="keyup changed delay:500ms" hx-target="#items-list"
               hx-include="[name='category_id'], [name='feed_id'], [name='search']">
    </div>
    <div class="col-md-3">
        <select class="form-select" name="category_id" id="category-selector"
                hx-get="/htmx/items-list" hx-trigger="change" hx-target="#items-list"
                hx-include="[name='search'], [name='feed_id'], [name='category_id']">
            <option value="0">All Categories</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" name="feed_id" id="feed-selector"
                hx-get="/htmx/items-list" hx-trigger="change" hx-target="#items-list"
                hx-include="[name='search'], [name='category_id'], [name='feed_id']">
            <option value="0">All Feeds</option>
        </select>
    </div>
</div>

<!-- Load options on page load -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Only load once
        if (!document.getElementById('feed-selector').dataset.loaded) {
            document.getElementById('feed-selector').dataset.loaded = 'true';

            // Load feed options
            htmx.ajax('GET', '/htmx/feeds-options', {
                target: '#feed-selector',
                swap: 'beforeend'
            });
        }

        if (!document.getElementById('category-selector').dataset.loaded) {
            document.getElementById('category-selector').dataset.loaded = 'true';

            // Load category options
            htmx.ajax('GET', '/htmx/categories-options', {
                target: '#category-selector',
                swap: 'beforeend'
            });
        }
    });
</script>

<div class="row">
    <!-- Left Column: Articles List -->
    <div class="col-lg-8">
        <div id="items-list" hx-get="/htmx/items-list" hx-trigger="load">
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading articles...</span>
                </div>
            </div>
        </div>

        <!-- Load More Button -->
        <div class="text-center mt-4">
            <button class="btn btn-outline-primary" id="load-more-btn"
                    hx-get="/htmx/items-list"
                    hx-include="[name='search'], [name='category_id'], [name='feed_id']"
                    hx-target="#items-list"
                    hx-swap="beforeend"
                    onclick="this.setAttribute('hx-vals', JSON.stringify({skip: document.querySelectorAll('#items-list .card').length.toString()}))">
                Load More
            </button>
        </div>
    </div>

    <!-- Right Column: Sticky Analysis Sidebar -->
    <div class="col-lg-4">
        <div id="analysis-sidebar" style="position: sticky; top: 20px;">
            <div class="text-muted text-center py-5">
                <i class="bi bi-info-circle"></i> Hover over an article to see analysis
            </div>
        </div>
    </div>
</div>

<script>
// Update sidebar with Finance/Geopolitical blocks on hover
document.addEventListener('DOMContentLoaded', function() {
    function updateSidebar(analysisData) {
        const sidebar = document.getElementById('analysis-sidebar');
        if (!analysisData || !analysisData.sentiment_json) {
            sidebar.innerHTML = '<div class="text-muted text-center py-5"><i class="bi bi-info-circle"></i> No analysis available</div>';
            return;
        }

        const sentiment = analysisData.sentiment_json;
        const impact = analysisData.impact_json || {};
        const market = sentiment.market || {};
        const geo = sentiment.geopolitical || {};

        // Market display
        const marketDisplay = market.bearish > 0.6 ? `üìâ Bearish (${market.bearish.toFixed(1)})` :
                             market.bullish > 0.6 ? `üìà Bullish (${market.bullish.toFixed(1)})` :
                             '‚û°Ô∏è Neutral';
        const timeHorizon = (market.time_horizon || 'medium').charAt(0).toUpperCase() + (market.time_horizon || 'medium').slice(1);

        // Finance Block
        let html = `
        <div class="finance-block p-3 mb-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
            <h6 class="mb-2">üí∞ Finance</h6>
            <div class="mb-1"><strong>Market:</strong> ${marketDisplay}</div>
            <div class="mb-1"><strong>Horizon:</strong> ${timeHorizon}</div>
            <div class="mb-1"><strong>Impact:</strong> ‚ö° ${(impact.overall || 0).toFixed(1)}</div>
            <div><strong>Volatility:</strong> üìà ${(impact.volatility || 0).toFixed(1)}</div>
        </div>`;

        // Geopolitical Block
        if (geo && geo.conflict_type) {
            const conflictType = (geo.conflict_type || 'N/A').replace(/_/g, ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            const regions = (geo.regions_affected || []).slice(0, 3).join(', ') || 'N/A';

            html += `
        <div class="geopolitical-block p-3 mb-2" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 8px; color: white;">
            <h6 class="mb-2">üåç Geopolitical</h6>
            <div class="mb-1"><strong>Type:</strong> ${conflictType}</div>
            <div class="mb-1"><strong>Security:</strong> ${(geo.security_relevance || 0).toFixed(1)}</div>
            <div class="mb-1"><strong>Escalation:</strong> ${(geo.escalation_potential || 0).toFixed(1)}</div>
            <div class="mb-1"><strong>Stability:</strong> ${(geo.stability_score || 0).toFixed(1)}</div>
            <div><strong>Regions:</strong> ${regions}</div>
        </div>`;
        }

        sidebar.innerHTML = html;
    }

    // Add hover listeners to article cards using delegation
    document.addEventListener('mouseover', function(e) {
        const card = e.target && e.target.closest ? e.target.closest('.article-card') : null;
        if (card) {
            const analysisJson = card.getAttribute('data-analysis');
            if (analysisJson && analysisJson !== '') {
                try {
                    const analysis = JSON.parse(analysisJson);
                    updateSidebar(analysis);
                } catch (err) {
                    console.error('Failed to parse analysis:', err);
                }
            }
        }
    });

    // Show first article's analysis after HTMX loads items
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'items-list') {
            setTimeout(() => {
                const firstCard = document.querySelector('.article-card');
                if (firstCard) {
                    const analysisJson = firstCard.getAttribute('data-analysis');
                    if (analysisJson && analysisJson !== '') {
                        try {
                            const analysis = JSON.parse(analysisJson);
                            updateSidebar(analysis);
                        } catch (err) {
                            console.error('Failed to parse analysis:', err);
                        }
                    }
                }
            }, 100);
        }
    });
});
</script>
{% endblock %}