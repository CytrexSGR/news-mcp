<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metrics Dashboard - News MCP</title>
    <link rel="stylesheet" href="/static/news-mcp.css">
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <nav class="nav">
            <div class="nav-brand">
                <h1>ðŸ“Š Metrics Dashboard</h1>
            </div>
            <div class="nav-links">
                <a href="/admin/feeds">Feeds</a>
                <a href="/admin/items">Items</a>
                <a href="/admin/analysis">Analysis</a>
                <a href="/admin/metrics" class="active">Metrics</a>
                <a href="/">Home</a>
            </div>
        </nav>

        <main class="main-content">
            <!-- System Overview -->
            <div class="card">
                <h2>ðŸ“ˆ System Overview</h2>
                <div id="system-overview" hx-get="/api/metrics/system/overview" hx-trigger="load, every 30s">
                    <div class="loading">Loading system metrics...</div>
                </div>
            </div>

            <!-- Feed Metrics -->
            <div class="card">
                <h2>ðŸ”„ Feed Performance</h2>
                <div class="feed-selector">
                    <label for="feed-select">Select Feed:</label>
                    <select id="feed-select" onchange="loadFeedMetrics(this.value)">
                        <option value="">-- Select a Feed --</option>
                    </select>
                </div>
                <div id="feed-metrics">
                    <div class="placeholder">Select a feed to view metrics</div>
                </div>
            </div>

            <!-- Queue Performance -->
            <div class="card">
                <h2>âš¡ Queue Performance</h2>
                <div id="queue-performance" hx-get="/api/metrics/performance/queue" hx-trigger="load, every 30s">
                    <div class="loading">Loading queue metrics...</div>
                </div>
            </div>

            <!-- Cost Breakdown -->
            <div class="card">
                <h2>ðŸ’° Cost Analysis</h2>
                <div class="cost-controls">
                    <label for="cost-days">Time Range:</label>
                    <select id="cost-days" onchange="loadCostBreakdown(this.value)">
                        <option value="1">Last 24 hours</option>
                        <option value="7" selected>Last 7 days</option>
                        <option value="30">Last 30 days</option>
                    </select>
                </div>
                <div id="cost-breakdown">
                    <div class="loading">Loading cost data...</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Load feeds for selection
        async function loadFeeds() {
            try {
                const response = await fetch('/api/feeds');
                const data = await response.json();
                const select = document.getElementById('feed-select');

                if (data.success && data.data) {
                    data.data.forEach(feed => {
                        const option = document.createElement('option');
                        option.value = feed.id;
                        option.textContent = `${feed.title} (ID: ${feed.id})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading feeds:', error);
            }
        }

        // Load metrics for specific feed
        async function loadFeedMetrics(feedId) {
            if (!feedId) {
                document.getElementById('feed-metrics').innerHTML =
                    '<div class="placeholder">Select a feed to view metrics</div>';
                return;
            }

            document.getElementById('feed-metrics').innerHTML =
                '<div class="loading">Loading feed metrics...</div>';

            try {
                const response = await fetch(`/api/metrics/feeds/${feedId}/summary`);
                const data = await response.json();

                if (data.success && data.data) {
                    displayFeedMetrics(data.data);
                } else {
                    throw new Error(data.error || 'Failed to load metrics');
                }
            } catch (error) {
                document.getElementById('feed-metrics').innerHTML =
                    `<div class="error">Error loading metrics: ${error.message}</div>`;
            }
        }

        // Display feed metrics
        function displayFeedMetrics(metrics) {
            const today = metrics.today;
            const lastWeek = metrics.last_7_days;

            let html = `
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>ðŸ“Š Today's Stats</h3>
                        ${today ? `
                            <div class="metric-row">
                                <span>Analyses:</span>
                                <span>${today.analysis_counts.total}</span>
                            </div>
                            <div class="metric-row">
                                <span>Items Processed:</span>
                                <span>${today.item_counts.total_processed}</span>
                            </div>
                            <div class="metric-row">
                                <span>Success Rate:</span>
                                <span>${today.performance.success_rate.toFixed(1)}%</span>
                            </div>
                            <div class="metric-row">
                                <span>Cost:</span>
                                <span>$${today.costs.total_usd.toFixed(4)}</span>
                            </div>
                        ` : '<div class="no-data">No data for today</div>'}
                    </div>

                    <div class="metric-card">
                        <h3>ðŸ“ˆ Last 7 Days</h3>
                        ${lastWeek ? `
                            <div class="metric-row">
                                <span>Total Analyses:</span>
                                <span>${lastWeek.total_analyses}</span>
                            </div>
                            <div class="metric-row">
                                <span>Total Items:</span>
                                <span>${lastWeek.total_items}</span>
                            </div>
                            <div class="metric-row">
                                <span>Avg Success Rate:</span>
                                <span>${lastWeek.avg_success_rate.toFixed(1)}%</span>
                            </div>
                            <div class="metric-row">
                                <span>Total Cost:</span>
                                <span>$${lastWeek.total_cost_usd.toFixed(4)}</span>
                            </div>
                        ` : '<div class="no-data">No data available</div>'}
                    </div>
                </div>
            `;

            if (today && today.model_usage) {
                html += `
                    <div class="model-usage">
                        <h3>ðŸ¤– Model Usage</h3>
                        <div class="model-grid">
                `;

                Object.entries(today.model_usage).forEach(([model, usage]) => {
                    html += `
                        <div class="model-card">
                            <h4>${model}</h4>
                            <div class="metric-row">
                                <span>Runs:</span>
                                <span>${usage.runs}</span>
                            </div>
                            <div class="metric-row">
                                <span>Items:</span>
                                <span>${usage.items}</span>
                            </div>
                            <div class="metric-row">
                                <span>Tokens:</span>
                                <span>${usage.tokens.toLocaleString()}</span>
                            </div>
                            <div class="metric-row">
                                <span>Cost:</span>
                                <span>$${usage.cost.toFixed(4)}</span>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            document.getElementById('feed-metrics').innerHTML = html;
        }

        // Load cost breakdown
        async function loadCostBreakdown(days) {
            document.getElementById('cost-breakdown').innerHTML =
                '<div class="loading">Loading cost data...</div>';

            try {
                const response = await fetch(`/api/metrics/costs/breakdown?days=${days}`);
                const data = await response.json();

                if (data.success && data.data) {
                    displayCostBreakdown(data.data);
                } else {
                    throw new Error(data.error || 'Failed to load cost data');
                }
            } catch (error) {
                document.getElementById('cost-breakdown').innerHTML =
                    `<div class="error">Error loading costs: ${error.message}</div>`;
            }
        }

        // Display cost breakdown
        function displayCostBreakdown(data) {
            const breakdown = data.breakdown;

            let html = `
                <div class="cost-summary">
                    <h3>ðŸ’° Cost Summary (${data.days} days)</h3>
                    <div class="cost-grid">
                        <div class="cost-card">
                            <span class="cost-label">Total Analyses:</span>
                            <span class="cost-value">${breakdown.system_totals?.total_analyses || 0}</span>
                        </div>
                        <div class="cost-card">
                            <span class="cost-label">Total Cost:</span>
                            <span class="cost-value">$${(breakdown.system_totals?.total_cost_usd || 0).toFixed(4)}</span>
                        </div>
                        <div class="cost-card">
                            <span class="cost-label">Active Feeds:</span>
                            <span class="cost-value">${breakdown.system_totals?.active_feeds || 0}</span>
                        </div>
                        <div class="cost-card">
                            <span class="cost-label">Items Processed:</span>
                            <span class="cost-value">${breakdown.system_totals?.total_items || 0}</span>
                        </div>
                    </div>
                </div>
            `;

            if (breakdown.top_spending_feeds && breakdown.top_spending_feeds.length > 0) {
                html += `
                    <div class="top-spenders">
                        <h3>ðŸ”¥ Top Spending Feeds</h3>
                        <div class="spender-list">
                `;

                breakdown.top_spending_feeds.forEach(feed => {
                    html += `
                        <div class="spender-item">
                            <span>Feed ${feed.feed_id}</span>
                            <span>$${feed.cost_usd.toFixed(4)}</span>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            document.getElementById('cost-breakdown').innerHTML = html;
        }

        // HTMX response handlers
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            const target = evt.detail.target;

            if (target.id === 'system-overview') {
                try {
                    const data = JSON.parse(evt.detail.xhr.responseText);
                    if (data.success && data.data) {
                        displaySystemOverview(data.data);
                    }
                } catch (error) {
                    target.innerHTML = '<div class="error">Error parsing system overview</div>';
                }
            } else if (target.id === 'queue-performance') {
                try {
                    const data = JSON.parse(evt.detail.xhr.responseText);
                    if (data.success && data.data) {
                        displayQueuePerformance(data.data);
                    }
                } catch (error) {
                    target.innerHTML = '<div class="error">Error parsing queue performance</div>';
                }
            }
        });

        // Display system overview
        function displaySystemOverview(data) {
            const totals = data.system_totals;
            const queue = data.queue_performance;

            let html = `
                <div class="overview-grid">
                    <div class="overview-card">
                        <h3>ðŸŽ¯ Today's Totals</h3>
                        <div class="metric-row">
                            <span>Analyses:</span>
                            <span>${totals?.total_analyses || 0}</span>
                        </div>
                        <div class="metric-row">
                            <span>Items:</span>
                            <span>${totals?.total_items || 0}</span>
                        </div>
                        <div class="metric-row">
                            <span>Active Feeds:</span>
                            <span>${totals?.active_feeds || 0}</span>
                        </div>
                        <div class="metric-row">
                            <span>Total Cost:</span>
                            <span>$${(totals?.total_cost_usd || 0).toFixed(4)}</span>
                        </div>
                    </div>

                    <div class="overview-card">
                        <h3>âš¡ Queue Status</h3>
                        <div class="metric-row">
                            <span>Processed:</span>
                            <span>${queue?.items_processed || 0}</span>
                        </div>
                        <div class="metric-row">
                            <span>Failed:</span>
                            <span>${queue?.items_failed || 0}</span>
                        </div>
                        <div class="metric-row">
                            <span>Avg Queue Time:</span>
                            <span>${(queue?.avg_queue_time_seconds || 0).toFixed(2)}s</span>
                        </div>
                    </div>
                </div>
            `;

            if (data.top_spending_feeds && data.top_spending_feeds.length > 0) {
                html += `
                    <div class="top-feeds">
                        <h3>ðŸ’° Top Spending Today</h3>
                        <div class="feed-list">
                `;

                data.top_spending_feeds.slice(0, 5).forEach(feed => {
                    html += `
                        <div class="feed-item">
                            <span>Feed ${feed.feed_id}</span>
                            <span>$${feed.cost_usd.toFixed(4)}</span>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            document.getElementById('system-overview').innerHTML = html;
        }

        // Display queue performance
        function displayQueuePerformance(data) {
            document.getElementById('queue-performance').innerHTML = `
                <div class="queue-status">
                    <p>${data.message || 'Queue performance monitoring is active'}</p>
                    <small>Queue metrics will be available once processing begins</small>
                </div>
            `;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadFeeds();
            loadCostBreakdown(7); // Load 7-day cost breakdown by default
        });
    </script>

    <style>
        .metrics-grid, .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .metric-card, .overview-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
        }

        .metric-card h3, .overview-card h3 {
            margin: 0 0 0.75rem 0;
            color: #495057;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .model-card {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 0.25rem;
            padding: 0.75rem;
        }

        .model-card h4 {
            margin: 0 0 0.5rem 0;
            color: #1976d2;
            font-size: 0.875rem;
        }

        .cost-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }

        .cost-card {
            background: #f1f8e9;
            border: 1px solid #c8e6c9;
            border-radius: 0.25rem;
            padding: 0.75rem;
            text-align: center;
        }

        .cost-label {
            display: block;
            font-size: 0.875rem;
            color: #558b2f;
            margin-bottom: 0.25rem;
        }

        .cost-value {
            display: block;
            font-size: 1.25rem;
            font-weight: bold;
            color: #33691e;
        }

        .feed-selector, .cost-controls {
            margin-bottom: 1rem;
        }

        .feed-selector label, .cost-controls label {
            display: inline-block;
            margin-right: 0.5rem;
            font-weight: 500;
        }

        .feed-selector select, .cost-controls select {
            padding: 0.375rem 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            background-color: white;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .placeholder {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
            font-style: italic;
        }

        .error {
            text-align: center;
            padding: 1rem;
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 0.25rem;
        }

        .no-data {
            text-align: center;
            padding: 1rem;
            color: #6c757d;
            font-style: italic;
        }

        .spender-list, .feed-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .spender-item, .feed-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .spender-item:last-child, .feed-item:last-child {
            border-bottom: none;
        }

        .queue-status {
            text-align: center;
            padding: 2rem;
        }

        .queue-status p {
            margin: 0 0 0.5rem 0;
            color: #495057;
        }

        .queue-status small {
            color: #6c757d;
        }
    </style>
</body>
</html>