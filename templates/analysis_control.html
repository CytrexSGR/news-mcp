{% extends "base.html" %}

{% block title %}Analysis Control Center - News MCP{% endblock %}

{% block extra_head %}
<script src="//unpkg.com/alpinejs" defer></script>
{% endblock %}

{% block content %}
<div class="container-fluid px-xl" x-data="analysisControl()">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-xl">
        <div>
            <h1 class="h3 mb-sm">Analysis Control Center</h1>
            <p class="nmc-text-muted mb-0">AI-powered sentiment and impact analysis with GPT models</p>
        </div>
        <div class="d-flex gap-sm">
            <button class="btn btn-outline-info btn-sm"
                    hx-get="/htmx/analysis/stats"
                    hx-target="#overview-stats"
                    hx-trigger="click">
                <i class="bi bi-arrow-clockwise me-sm"></i> Refresh
            </button>
        </div>
    </div>

    <!-- 3-Tab Navigation -->
    <div class="nmc-card mb-xl">
        <ul class="nav nav-tabs" id="analysisControlTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active px-lg py-md" id="start-tab" data-bs-toggle="tab"
                        data-bs-target="#start-panel" type="button" role="tab">
                    <i class="bi bi-play-circle me-sm"></i> Start Analysis
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link px-lg py-md" id="runs-tab" data-bs-toggle="tab"
                        data-bs-target="#runs-panel" type="button" role="tab">
                    <i class="bi bi-list-task me-sm"></i> Active Runs
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link px-lg py-md" id="settings-tab" data-bs-toggle="tab"
                        data-bs-target="#settings-panel" type="button" role="tab">
                    <i class="bi bi-gear me-sm"></i> Settings
                </button>
            </li>
        </ul>

        <div class="tab-content" id="analysisControlTabContent">
            <!-- Start Analysis Tab -->
            <div class="tab-pane fade show active p-xl" id="start-panel" role="tabpanel">
                <div class="row gap-xl">
                    <!-- Quick Start Column -->
                    <div class="col-lg-7">
                        <h5 class="mb-lg">Quick Start Analysis</h5>

                        <!-- Target Selection -->
                        <div class="nmc-card mb-lg">
                            <div class="card-body py-lg px-lg">
                                <h6 class="mb-lg">Select Target Articles</h6>

                                <!-- Main Selection Mode (Exclusive) -->
                                <div class="mb-lg">
                                    <h6 class="mb-md text-muted">Selection Mode (choose one):</h6>

                                    <!-- Latest Articles Option -->
                                    <div class="mb-md" :class="selectionMode === 'latest' ? 'bg-light p-sm rounded' : ''">
                                        <div class="d-flex align-items-center gap-md">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="selectionMode"
                                                       value="latest" x-model="selectionMode" id="modeLatest">
                                                <label class="form-check-label fw-bold" for="modeLatest">
                                                    Latest N Articles
                                                </label>
                                            </div>
                                            <input type="number" class="form-control" style="width: 100px;"
                                                   x-model="latestCount" :disabled="selectionMode !== 'latest'"
                                                   placeholder="50" min="1" max="1000" value="50">
                                            <button type="button" class="btn btn-success btn-sm"
                                                    :disabled="selectionMode !== 'latest'"
                                                    @click="setLatestSelection()">
                                                <i class="bi bi-check"></i> SET
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Time Range Option -->
                                    <div class="mb-md" :class="selectionMode === 'timeRange' ? 'bg-light p-sm rounded' : ''">
                                        <div class="d-flex align-items-center gap-md">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="selectionMode"
                                                       value="timeRange" x-model="selectionMode" id="modeTimeRange">
                                                <label class="form-check-label fw-bold" for="modeTimeRange">
                                                    Time Range
                                                </label>
                                            </div>
                                            <div class="d-flex gap-xs">
                                                <div class="input-group input-group-sm" style="width: 100px;">
                                                    <input type="number" class="form-control"
                                                           x-model="timeRangeDays" :disabled="selectionMode !== 'timeRange'"
                                                           placeholder="7" min="0" max="365" value="7">
                                                    <span class="input-group-text">T</span>
                                                </div>
                                                <div class="input-group input-group-sm" style="width: 100px;">
                                                    <input type="number" class="form-control"
                                                           x-model="timeRangeHours" :disabled="selectionMode !== 'timeRange'"
                                                           placeholder="0" min="0" max="23" value="0">
                                                    <span class="input-group-text">H</span>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-success btn-sm"
                                                    :disabled="selectionMode !== 'timeRange'"
                                                    @click="setTimeRangeSelection()">
                                                <i class="bi bi-check"></i> SET
                                            </button>
                                        </div>
                                    </div>

                                    <!-- All Unanalyzed Option -->
                                    <div class="mb-md" :class="selectionMode === 'unanalyzed' ? 'bg-light p-sm rounded' : ''">
                                        <div class="d-flex align-items-center gap-md">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="selectionMode"
                                                       value="unanalyzed" x-model="selectionMode" id="modeUnanalyzed">
                                                <label class="form-check-label fw-bold" for="modeUnanalyzed">
                                                    All Unanalyzed Articles
                                                </label>
                                            </div>
                                            <button type="button" class="btn btn-success btn-sm"
                                                    :disabled="selectionMode !== 'unanalyzed'"
                                                    @click="setUnanalyzedSelection()">
                                                <i class="bi bi-check"></i> SET
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Active Selection Display -->
                                <div class="alert alert-info mb-lg" x-show="activeSelection.description">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong>Active Selection:</strong> <span x-text="activeSelection.description"></span>
                                            <br>
                                            <div class="row mt-sm">
                                                <div class="col-md-4">
                                                    <small class="text-muted">Total items: <strong x-text="preview.total_items || '...'"></strong></small>
                                                </div>
                                                <div class="col-md-4">
                                                    <small class="text-success">Already analyzed: <strong x-text="preview.analyzed_items || '...'"></strong></small>
                                                </div>
                                                <div class="col-md-4">
                                                    <small class="text-warning">To analyze: <strong x-text="preview.item_count || '...'"></strong></small>
                                                </div>
                                            </div>
                                            <div class="mt-xs" x-show="preview.analyzed_items > 0">
                                                <small class="text-muted">
                                                    <i class="bi bi-info-circle"></i>
                                                    <span x-text="filters.override_existing ? 'Will re-analyze existing items' : 'Will skip already analyzed items'"></span>
                                                </small>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-outline-danger btn-sm" @click="clearSelection()">
                                            <i class="bi bi-x-circle"></i> Clear
                                        </button>
                                    </div>
                                </div>

                                <!-- Additive Filters -->
                                <div class="mb-lg">
                                    <h6 class="mb-md text-muted">Additional Filters:</h6>

                                    <!-- Feed Filter -->
                                    <div class="row gap-md mb-md">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       x-model="filters.useFeedFilter" id="useFeedFilter">
                                                <label class="form-check-label" for="useFeedFilter">
                                                    Specific Feed only
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <select class="form-select form-select-sm" x-model="filters.feed_id"
                                                    hx-get="/htmx/analysis/feeds-list-options" hx-trigger="load" hx-target="this">
                                                <option value="">Select Feed</option>
                                                <!-- Options loaded via HTMX -->
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Other Filters -->
                                    <div class="row gap-md">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       x-model="filters.unanalyzed_only" id="filterUnanalyzed">
                                                <label class="form-check-label" for="filterUnanalyzed">
                                                    Exclude already analyzed
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       x-model="filters.override_existing" id="filterOverride">
                                                <label class="form-check-label" for="filterOverride">
                                                    Override existing analysis
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Model & Parameters -->
                        <div class="nmc-card mb-lg">
                            <div class="card-body py-lg px-lg">
                                <h6 class="mb-lg">Analysis Parameters</h6>
                                <div class="row gap-md">
                                    <div class="col-md-5">
                                        <label class="form-label">AI Model</label>
                                        <select class="form-select" x-model="params.model_tag">
                                            <option value="gpt-4.1-nano">GPT-4.1 Nano (Recommended)</option>
                                            <option value="gpt-4o-mini">GPT-4o Mini</option>
                                            <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
                                        </select>
                                    </div>
                                    <div class="col-md-5">
                                        <label class="form-label">Processing Rate</label>
                                        <select class="form-select" x-model="params.rate_per_second">
                                            <option value="0.5">0.5/sec (Conservative)</option>
                                            <option value="1.0">1.0/sec (Standard)</option>
                                            <option value="2.0">2.0/sec (Fast)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Preview & Start -->
                        <div class="nmc-card">
                            <div class="card-body py-lg px-lg">
                                <div class="d-flex justify-content-between align-items-center mb-lg">
                                    <h6 class="mb-0">Analysis Preview</h6>
                                    <button class="btn btn-outline-primary btn-sm" @click="updatePreview()">
                                        <i class="bi bi-arrow-clockwise"></i> Update
                                    </button>
                                </div>

                                <div id="run-preview" class="alert alert-info">
                                    <div class="row text-center">
                                        <div class="col-3">
                                            <strong x-text="preview.item_count || '0'"></strong><br>
                                            <small>Items</small>
                                        </div>
                                        <div class="col-3">
                                            <strong x-text="'$' + (preview.estimated_cost_usd || 0).toFixed(4)"></strong><br>
                                            <small>Cost</small>
                                        </div>
                                        <div class="col-3">
                                            <strong x-text="(preview.estimated_duration_minutes || 0) + 'm'"></strong><br>
                                            <small>Duration</small>
                                        </div>
                                        <div class="col-3">
                                            <button class="btn btn-success"
                                                    :disabled="!preview.item_count || preview.item_count === 0"
                                                    @click="startRun()">
                                                <i class="bi bi-play"></i> Start
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Column -->
                    <div class="col-lg-4">
                        <div class="nmc-card nmc-stat-card mb-lg">
                            <div class="stat-number" id="overview-stats" hx-get="/htmx/analysis/stats" hx-trigger="load, every 30s">
                                <div class="nmc-skeleton skeleton-text"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Runs Tab -->
            <div class="tab-pane fade p-xl" id="runs-panel" role="tabpanel">
                <div class="nmc-card nmc-table-card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Active Analysis Runs</h6>
                            <button class="btn btn-outline-primary btn-sm"
                                    hx-get="/htmx/analysis/active-runs"
                                    hx-target="#active-runs-table">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div id="active-runs-table" hx-get="/htmx/analysis/active-runs" hx-trigger="load, every 10s">
                        <div class="nmc-skeleton-card">
                            <div class="nmc-skeleton-lines">
                                <div class="nmc-skeleton skeleton-text"></div>
                                <div class="nmc-skeleton skeleton-text"></div>
                                <div class="nmc-skeleton skeleton-text"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="nmc-card nmc-table-card mt-xl">
                    <div class="card-header">
                        <h6 class="mb-0">Recent Completed Runs</h6>
                    </div>
                    <div id="run-history-table" hx-get="/htmx/analysis/history" hx-trigger="load">
                        <div class="nmc-skeleton-card">
                            <div class="nmc-skeleton-lines">
                                <div class="nmc-skeleton skeleton-text"></div>
                                <div class="nmc-skeleton skeleton-text"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade p-xl" id="settings-panel" role="tabpanel">
                <div class="row gap-xl">
                    <div class="col-lg-6">
                        <div class="nmc-card">
                            <div class="card-body py-lg px-lg">
                                <h6 class="mb-lg">Default Parameters</h6>
                                <div class="mb-md">
                                    <label class="form-label">Default Model</label>
                                    <select class="form-select" x-model="defaultParams.model_tag">
                                        <option value="gpt-4.1-nano">GPT-4.1 Nano</option>
                                        <option value="gpt-4o-mini">GPT-4o Mini</option>
                                    </select>
                                </div>
                                <div class="mb-md">
                                    <label class="form-label">Default Rate (per second)</label>
                                    <input type="number" class="form-control"
                                           x-model="defaultParams.rate_per_second"
                                           min="0.1" max="3.0" step="0.1">
                                </div>
                                <div class="mb-lg">
                                    <label class="form-label">Default Limit</label>
                                    <input type="number" class="form-control"
                                           x-model="defaultParams.limit"
                                           min="1" max="5000">
                                </div>
                                <button class="btn btn-primary" @click="saveDefaultParams()">
                                    <i class="bi bi-save"></i> Save Defaults
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-5">
                        <div class="nmc-card nmc-status-card">
                            <div class="status-header">
                                <div class="status-indicator green"></div>
                                <div class="status-title">Analysis System</div>
                            </div>
                            <div class="status-description">Worker integration with OpenAI GPT models for real-time analysis</div>
                            <div class="status-actions">
                                <a href="/admin/health" class="btn btn-outline-info btn-sm">System Health</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Simplified Alpine.js Controller -->
<script>
function analysisControl() {
    return {
        // Selection Mode System
        selectionMode: 'timeRange', // 'latest', 'timeRange', 'unanalyzed'

        // Selection Parameters
        latestCount: 50,
        timeRangeDays: 7,
        timeRangeHours: 0,

        // Active Selection State
        activeSelection: {
            mode: null,
            params: {},
            description: ''
        },

        // Additive Filters
        filters: {
            useFeedFilter: false,
            feed_id: '',
            unanalyzed_only: false,
            override_existing: false
        },

        // Analysis Parameters
        params: {
            model_tag: 'gpt-4.1-nano',
            rate_per_second: 1.0,
            limit: 200
        },
        defaultParams: {
            model_tag: 'gpt-4.1-nano',
            rate_per_second: 1.0,
            limit: 200
        },
        preview: {
            item_count: 0,
            estimated_cost_usd: 0,
            estimated_duration_minutes: 0
        },

        init() {
            this.loadDefaultParams();
            this.updatePreview();
        },

        // Selection Mode Functions
        setLatestSelection() {
            this.activeSelection = {
                mode: 'latest',
                params: { count: this.latestCount },
                description: `Latest ${this.latestCount} articles`
            };
            console.log('Set Latest Selection:', this.activeSelection);
            this.updatePreview();
        },

        setTimeRangeSelection() {
            const totalHours = (this.timeRangeDays * 24) + parseInt(this.timeRangeHours);
            let description = '';

            if (this.timeRangeDays > 0 && this.timeRangeHours > 0) {
                description = `Last ${this.timeRangeDays} days and ${this.timeRangeHours} hours`;
            } else if (this.timeRangeDays > 0) {
                description = `Last ${this.timeRangeDays} day${this.timeRangeDays > 1 ? 's' : ''}`;
            } else if (this.timeRangeHours > 0) {
                description = `Last ${this.timeRangeHours} hour${this.timeRangeHours > 1 ? 's' : ''}`;
            } else {
                description = 'All time';
            }

            this.activeSelection = {
                mode: 'timeRange',
                params: {
                    days: this.timeRangeDays,
                    hours: this.timeRangeHours,
                    totalHours: totalHours
                },
                description: description
            };
            console.log('Set Time Range Selection:', this.activeSelection);
            this.updatePreview();
        },

        setUnanalyzedSelection() {
            this.activeSelection = {
                mode: 'unanalyzed',
                params: {},
                description: 'All unanalyzed articles'
            };
            console.log('Set Unanalyzed Selection:', this.activeSelection);
            this.updatePreview();
        },

        clearSelection() {
            this.activeSelection = {
                mode: null,
                params: {},
                description: ''
            };
            this.selectionMode = 'timeRange'; // Reset to default
            console.log('Selection cleared');
            this.updatePreview();
        },

        setTimeRange(range) {
            console.log(`Set time range: ${range}`);
            this.updatePreview();
        },

        async updatePreview() {
            try {
                let totalItems = 0;
                let analyzedItems = 0;

                // Calculate total items based on active selection
                if (this.activeSelection.mode === 'latest') {
                    totalItems = this.activeSelection.params.count || 50;
                    analyzedItems = Math.floor(totalItems * 0.7); // Estimate 70% already analyzed
                } else if (this.activeSelection.mode === 'timeRange') {
                    // Estimate based on time range (rough calculation)
                    const totalHours = this.activeSelection.params.totalHours || 24;
                    totalItems = Math.min(totalHours * 10, 1000); // ~10 articles per hour, max 1000
                    analyzedItems = Math.floor(totalItems * 0.6); // Estimate 60% already analyzed
                } else if (this.activeSelection.mode === 'unanalyzed') {
                    totalItems = 500; // Estimate for unanalyzed
                    analyzedItems = 0; // By definition, none analyzed
                } else {
                    totalItems = 0; // No selection active
                    analyzedItems = 0;
                }

                // Apply feed filter effect on total
                if (this.filters.useFeedFilter && this.filters.feed_id) {
                    totalItems = Math.floor(totalItems * 0.3); // Feed filter reduces count
                    analyzedItems = Math.floor(analyzedItems * 0.3);
                }

                // Calculate items to analyze based on filters
                let itemsToAnalyze = 0;

                if (this.filters.override_existing) {
                    // Re-analyze everything
                    itemsToAnalyze = totalItems;
                } else if (this.filters.unanalyzed_only) {
                    // Only unanalyzed items
                    itemsToAnalyze = totalItems - analyzedItems;
                } else {
                    // Default: skip already analyzed
                    itemsToAnalyze = totalItems - analyzedItems;
                }

                // Calculate costs and duration based on items to analyze
                this.preview = {
                    total_items: totalItems,
                    analyzed_items: analyzedItems,
                    item_count: itemsToAnalyze,
                    estimated_cost_usd: itemsToAnalyze * 0.0003,
                    estimated_duration_minutes: Math.ceil(itemsToAnalyze / (this.params.rate_per_second * 60))
                };

                console.log('Preview updated:', this.preview);
            } catch (error) {
                console.error('Preview update failed:', error);
            }
        },

        buildQuery() {
            if (!this.activeSelection.mode) {
                return null; // No selection active
            }

            let query = {
                selection_mode: this.activeSelection.mode,
                ...this.activeSelection.params
            };

            // Add additive filters
            if (this.filters.useFeedFilter && this.filters.feed_id) {
                query.feed_id = this.filters.feed_id;
            }

            if (this.filters.unanalyzed_only) {
                query.unanalyzed_only = true;
            }

            if (this.filters.override_existing) {
                query.override_existing = true;
            }

            return query;
        },

        async startRun() {
            try {
                const query = this.buildQuery();
                if (!query) {
                    alert('Please select a target article selection first by clicking a SET button.');
                    return;
                }

                console.log('Starting analysis run with query:', query);

                // Add analysis parameters
                const fullQuery = {
                    ...query,
                    model_tag: this.params.model_tag,
                    rate_per_second: this.params.rate_per_second,
                    limit: this.params.limit
                };

                console.log('Full analysis parameters:', fullQuery);
                // This would call the actual API
                alert(`Analysis run started successfully!\nSelection: ${this.activeSelection.description}\nEstimated items: ${this.preview.item_count}`);
            } catch (error) {
                console.error('Failed to start run:', error);
                alert('Failed to start run: ' + error.message);
            }
        },

        async loadDefaultParams() {
            try {
                // Load default parameters from server
                console.log('Loading default parameters...');
            } catch (error) {
                console.error('Failed to load default parameters:', error);
            }
        },

        async saveDefaultParams() {
            try {
                console.log('Saving default parameters...');
                alert('Default parameters saved successfully!');
            } catch (error) {
                console.error('Failed to save parameters:', error);
                alert('Failed to save parameters: ' + error.message);
            }
        }
    }
}
</script>
{% endblock %}