<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Control Center - News MCP</title>
    <script src="//unpkg.com/alpinejs" defer></script>
    <script src="//unpkg.com/htmx.org@1.9.8"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/news-mcp.css">
    <link rel="stylesheet" href="/static/css/analysis.css">
    <style>
        body {
            background-color: #0d1117 !important;
            color: #c9d1d9 !important;
        }
        .container-fluid {
            background-color: #0d1117 !important;
        }
        h2, h5 {
            color: #c9d1d9 !important;
        }
    </style>
</head>
<body class="bg-dark">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-rss"></i> News MCP
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="/admin/feeds">
                        <i class="fas fa-rss"></i> Feeds
                    </a>
                    <a class="nav-link" href="/admin/items">
                        <i class="fas fa-newspaper"></i> Articles
                    </a>
                    <a class="nav-link active" href="/admin/analysis">
                        <i class="fas fa-brain"></i> Analysis
                    </a>
                    <a class="nav-link" href="/admin/templates">
                        <i class="fas fa-cogs"></i> Templates
                    </a>
                    <a class="nav-link" href="/admin/statistics">
                        <i class="fas fa-chart-line"></i> Statistics
                    </a>
                    <a class="nav-link" href="/admin/database">
                        <i class="fas fa-database"></i> Database
                    </a>
                    <a class="nav-link" href="/admin/health">
                        <i class="fas fa-heartbeat"></i> Health
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-lg">üß† Analysis Control Center</h2>
            </div>
        </div>

        <!-- 3-Tab Navigation -->
        <div class="nmc-tabs mb-lg">
            <button class="nmc-tab active" onclick="switchTab('start-analysis')">
                ‚ñ∂Ô∏è Start Analysis
            </button>
            <button class="nmc-tab" onclick="switchTab('active-runs')">
                üîÑ Active Runs
            </button>
            <button class="nmc-tab" onclick="switchTab('settings')">
                ‚öôÔ∏è Settings
            </button>
        </div>

        <!-- Tab Content -->
        <div x-data="analysisControl()">
            <!-- Start Analysis Tab -->
            <div id="start-analysis-tab" class="tab-content">
                <form id="analysis-form">
                    <!-- Horizontal System Statistics -->
                    <div id="stats-horizontal"
                         hx-get="/htmx/analysis/stats-horizontal"
                         hx-trigger="load, every 30s"
                         hx-swap="innerHTML">
                        <div class="d-flex justify-content-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading statistics...</span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Left Column: Target Selection + Controls -->
                        <div class="col-lg-5">
                            <!-- Target Selection -->
                            <div class="nmc-card">
                                <h5 class="mb-md">üéØ Target Selection</h5>
                                <div hx-get="/htmx/analysis/target-selection"
                                     hx-trigger="load"
                                     hx-swap="innerHTML">
                                    {% include 'partials/analysis_target_selection.html' %}
                                </div>
                            </div>

                            <!-- Model & Parameters -->
                            <div class="nmc-card">
                                <h5 class="mb-md">‚öôÔ∏è Model & Parameters</h5>
                                <div hx-get="/htmx/analysis/model-params"
                                     hx-trigger="load"
                                     hx-swap="innerHTML">
                                    {% include 'partials/analysis_model_params.html' %}
                                </div>
                            </div>

                            <!-- Preview & Start -->
                            <div class="nmc-card">
                                <h5 class="mb-md">üìä Preview & Start</h5>
                                <div hx-get="/htmx/analysis/preview-start"
                                     hx-trigger="load"
                                     hx-swap="innerHTML">
                                    {% include 'partials/analysis_preview_start.html' %}
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Live Articles -->
                        <div class="col-lg-7">
                            <div id="articles-live"
                                 hx-get="/htmx/analysis/articles-live"
                                 hx-trigger="load"
                                 hx-swap="innerHTML">
                                <div class="card bg-dark border-secondary">
                                    <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 400px;">
                                        <div class="text-center">
                                            <div class="spinner-border text-primary mb-3" role="status">
                                                <span class="visually-hidden">Loading articles...</span>
                                            </div>
                                            <p class="text-muted">Loading live articles...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Active Runs Tab -->
            <div id="active-runs-tab" class="tab-content" style="display:none;">
                <div class="row">
                    <div class="col-12">
                        <div id="active-runs-container">
                            {% include 'partials/analysis_active_runs.html' %}
                        </div>

                        <h5 class="mt-lg mb-md">üìú History</h5>
                        <div id="history-container">
                            {% include 'partials/analysis_history.html' %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content" style="display:none;">
                <div class="row">
                    <div class="col-lg-8">
                        {% include 'partials/analysis_settings.html' %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load JavaScript -->
    <script src="/static/js/analysis-controller.js"></script>
    <script>
        // Simple tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.nmc-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';

            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // Live Articles Update Functions
        function updateLiveArticles(mode, count = null, feedId = null, dateFrom = null, dateTo = null) {
            const articlesContainer = document.getElementById('articles-live');
            if (!articlesContainer) return;

            // Build URL with parameters
            let url = '/htmx/analysis/articles-live?mode=' + mode;

            if (count && mode === 'latest') {
                url += '&count=' + count;
            }
            if (feedId && mode === 'feed') {
                url += '&feed_id=' + feedId;
            }
            if (dateFrom && dateTo && mode === 'date_range') {
                url += '&date_from=' + encodeURIComponent(dateFrom);
                url += '&date_to=' + encodeURIComponent(dateTo);
            }

            // Show loading indicator
            articlesContainer.innerHTML = `
                <div class="card bg-dark border-secondary">
                    <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 400px;">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Updating articles...</span>
                            </div>
                            <p class="text-muted">Updating live articles...</p>
                        </div>
                    </div>
                </div>
            `;

            // Fetch and update
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    articlesContainer.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error updating live articles:', error);
                    articlesContainer.innerHTML = `
                        <div class="card bg-dark border-danger">
                            <div class="card-body text-center">
                                <div class="text-danger">
                                    <i class="bi bi-exclamation-triangle mb-2"></i>
                                    <p>Error loading articles. Please try again.</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
        }

        function clearSelection() {
            // Clear the active selection preview
            document.getElementById('active-selection').innerHTML = '';

            // Reset articles to show all (default)
            updateLiveArticles('all');
        }

        // Auto-refresh articles every 2 minutes
        setInterval(() => {
            const articlesContainer = document.getElementById('articles-live');
            if (articlesContainer && articlesContainer.innerHTML.includes('Live Articles')) {
                // Only refresh if no active selection is shown
                const activeSelection = document.getElementById('active-selection');
                if (!activeSelection || activeSelection.innerHTML.trim() === '') {
                    updateLiveArticles('all');
                }
            }
        }, 120000); // 2 minutes
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>